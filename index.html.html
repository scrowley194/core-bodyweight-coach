<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Core & Bodyweight Coach</title>
<style>
:root{
  --bg:#0f1115;
  --card:#161a22;
  --ink:#e9ecf1;
  --muted:#a8b0bf;
  --brand:#6ee7b7;
  --accent:#60a5fa;
  --danger:#f87171;
  --ok:#34d399;
  --warn:#fbbf24;
  --shadow:0 10px 30px rgba(0,0,0,.35);
  --radius:16px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
  color:var(--ink);
  background:
    radial-gradient(1200px 800px at 80% -10%, rgba(96,165,250,.12), transparent 40%),
    radial-gradient(800px 600px at -10% 120%, rgba(110,231,183,.1), transparent 40%),
    var(--bg);
}
.container{
  max-width:1000px;
  margin:0 auto;
  padding:24px;
}
.header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:16px;
  margin-bottom:16px;
}
.brand{
  display:flex;align-items:center;gap:12px;
}
.brand .logo{
  width:42px;height:42px;border-radius:12px;
  display:grid;place-items:center;
  background:linear-gradient(135deg,var(--accent),var(--brand));
  box-shadow:var(--shadow);
}
.brand h1{
  margin:0;font-size:1.25rem;letter-spacing:.3px;
}
.controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
button, .btn{
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  border:1px solid rgba(255,255,255,.1);
  color:var(--ink);
  padding:10px 14px;border-radius:12px;
  cursor:pointer;
  transition:.2s transform ease,.2s background ease,.2s border ease;
  font-weight:600;
}
button:hover{transform:translateY(-1px)}
button.primary{background:linear-gradient(135deg,var(--accent),var(--brand)); color:#0b1020; border-color:transparent}
button.ghost{background:transparent;border:1px dashed rgba(255,255,255,.22);color:var(--muted)}
button.danger{background:linear-gradient(135deg,#ef4444,#f59e0b);color:#200}
.grid{
  display:grid;gap:16px;
  grid-template-columns: repeat(12,1fr);
}
.card{
  background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
  border:1px solid rgba(255,255,255,.09);
  border-radius:var(--radius);
  padding:16px; box-shadow:var(--shadow);
}
.hero{
  grid-column:span 12;
  display:grid;grid-template-columns:1.1fr .9fr;gap:16px;
}
@media (max-width:900px){
  .hero{grid-template-columns:1fr; gap:12px}
}
.h1{font-size:1.8rem;margin:.2rem 0 .6rem}
.lede{color:var(--muted);margin:.25rem 0 1rem;line-height:1.45}
.pill{
  display:inline-flex;align-items:center;gap:8px;
  padding:8px 12px;border-radius:999px;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.08);
  margin-right:8px;
  font-size:.9rem;color:var(--muted)
}
.kpis{display:flex;gap:12px;flex-wrap:wrap}
.kpi{display:flex;flex-direction:column;gap:6px;min-width:120px}
.kpi .big{font-size:1.5rem;font-weight:800}
.row{display:flex;gap:10px;flex-wrap:wrap}
.section-title{display:flex;align-items:center;justify-content:space-between;margin:8px 0 6px}
.badge{font-size:.8rem;color:var(--muted)}
.cards-3{grid-column:span 12;display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
@media (max-width:900px){.cards-3{grid-template-columns:1fr}}
.exercise-list{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
@media (max-width:700px){.exercise-list{grid-template-columns:1fr}}
.exercise{
  display:flex;gap:12px;align-items:stretch;background:rgba(255,255,255,.03);
  border:1px solid rgba(255,255,255,.07);border-radius:14px;padding:10px
}
.exercise .icon{
  width:46px;height:46px;border-radius:12px;display:grid;place-items:center;
  background:linear-gradient(135deg, rgba(96,165,250,.35), rgba(110,231,183,.35));
}
.exercise .body{flex:1}
.exercise .title{margin:0 0 2px;font-weight:700}
.exercise .meta{font-size:.85rem;color:var(--muted)}
footer{margin:24px 0;color:var(--muted);text-align:center;font-size:.9rem}

.timer{
  grid-column:span 12;
  display:grid; grid-template-columns:1fr; gap:12px;
}
.display{
  display:grid; place-items:center;
  min-height:180px; border-radius:16px;
  background:
    radial-gradient(400px 200px at 100% 0%, rgba(96,165,250,.08), transparent 50%),
    radial-gradient(400px 200px at 0% 100%, rgba(110,231,183,.08), transparent 50%),
    rgba(255,255,255,.02);
  border:1px solid rgba(255,255,255,.08);
}
.time{
  font-size:3.5rem; font-weight:900; letter-spacing:1px;
}
.stage{color:var(--muted);margin-top:4px}
.progress{
  width:100%; height:12px; background:rgba(255,255,255,.06);
  border-radius:999px; overflow:hidden; border:1px solid rgba(255,255,255,.08);
}
.progress .bar{height:100%; width:0%;
  background:linear-gradient(90deg,var(--brand),var(--accent));
  transition:width .2s linear;
}
.controls-row{display:flex; gap:8px; flex-wrap:wrap; justify-content:center}
.small{font-size:.88rem}
.toggle{display:inline-flex;align-items:center;gap:8px}
.toggle input{accent-color:var(--accent)}

.list{list-style:none;margin:0;padding:0}
.list li{display:flex;justify-content:space-between;padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.06);background:rgba(255,255,255,.03);margin-bottom:8px}
.list li small{color:var(--muted)}

.notice{background:rgba(110,231,183,.12); border:1px solid rgba(110,231,183,.4); color:#d1fae5; padding:10px 12px; border-radius:12px}

a.link{color:var(--accent);text-decoration:none;border-bottom:1px dashed rgba(255,255,255,.3)}
a.link:hover{opacity:.9}

hr.sep{border:0;border-top:1px dashed rgba(255,255,255,.15);margin:8px 0}

/* Onboarding */
#onboard{
  position:fixed; inset:0; background:rgba(0,0,0,.55);
  display:none; align-items:center; justify-content:center; z-index:50;
}
#onboard .sheet{
  width:min(700px,92vw);
  background:var(--card); border:1px solid rgba(255,255,255,.12);
  border-radius:18px; box-shadow:var(--shadow); padding:18px;
}
.opt-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin:10px 0}
.opt{padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);cursor:pointer}
.opt.active{border-color:var(--accent);background:rgba(96,165,250,.08)}

/* Skills ladder popover */
.pop{
  position:absolute; background:var(--card); border:1px solid rgba(255,255,255,.1);
  border-radius:12px; box-shadow:var(--shadow); padding:10px; z-index:20;
}
.pop button{width:100%; text-align:left; margin:4px 0}

/* Audio only */
.audio-only .hero,
.audio-only .cards-3,
.audio-only .header .controls .not-audio,
.audio-only footer { display:none !important }
.audio-only .display{min-height:120px}
.audio-only .time{font-size:3rem}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="brand">
      <div class="logo" aria-hidden="true">
        <svg width="26" height="26" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 3c4.97 0 9 4.03 9 9 0 3.08-1.55 5.8-3.91 7.45a1 1 0 0 1-1.39-1.39A7 7 0 1 0 12 19a1 1 0 1 1 0 2c-4.97 0-9-4.03-9-9s4.03-9 9-9Z" fill="white" opacity=".85"/>
          <circle cx="12" cy="12" r="4" fill="white"/>
        </svg>
      </div>
      <h1>Core & Bodyweight Coach</h1>
    </div>
    <div class="controls">
      <label class="toggle small"><input type="checkbox" id="soundToggle" checked> Sound</label>
      <label class="toggle small"><input type="checkbox" id="voiceToggle"> Voice cues</label>
      <label class="toggle small"><input type="checkbox" id="audioOnly"> Audio only</label>
      <button class="ghost small not-audio" id="historyBtn" aria-label="View history">History</button>
      <button class="ghost small not-audio" id="onboardBtn" aria-label="Open set-up">Set up</button>
      <button class="ghost small" id="resetBtn" aria-label="Reset data">Reset</button>
    </div>
  </div>

  <div class="grid">
    <section class="card hero" aria-label="Overview">
      <div>
        <div class="pill">No kit required</div>
        <div class="pill">Ab focused</div>
        <h2 class="h1">Train your core and move better with smart intervals</h2>
        <p class="lede">Pick a session length, hit start, and follow clear cues. The plan adapts by adjusting work and rest. Log how it felt to guide progression next time.</p>
        <div class="row">
          <button class="primary" id="quick10">Quick 10</button>
          <button class="primary" id="quick20">Solid 20</button>
          <button class="primary" id="quick30">Complete 30</button>
          <button class="ghost" id="buildBtn">Build a week</button>
        </div>
        <div class="kpis" style="margin-top:12px">
          <div class="kpi">
            <div class="big" id="streak">0</div>
            <div class="small">Day streak</div>
          </div>
          <div class="kpi">
            <div class="big" id="sessions">0</div>
            <div class="small">Sessions done</div>
          </div>
          <div class="kpi">
            <div class="big" id="nextUp">None</div>
            <div class="small">Next up</div>
          </div>
        </div>
      </div>
      <div class="card" style="display:flex;flex-direction:column;justify-content:center">
        <div class="notice">Tip: keep ribs down, breathe through the nose, and move slow before fast. Quality first.</div>
        <hr class="sep">
        <ul class="list" id="planList" aria-label="Weekly plan"></ul>
        <div class="row">
          <button id="startToday" class="primary">Start today</button>
          <button id="shuffle" class="ghost">Shuffle plan</button>
        </div>
        <hr class="sep">
        <div>
          <strong>Weekly challenges</strong>
          <ul class="list" id="challengeList"></ul>
        </div>
      </div>
    </section>

    <section class="card cards-3" aria-label="Sessions">
      <div class="card">
        <div class="section-title">
          <h3 style="margin:0">Ab foundations</h3>
          <span class="badge">Control</span>
        </div>
        <div class="exercise-list" id="setA"></div>
      </div>
      <div class="card">
        <div class="section-title">
          <h3 style="margin:0">Power & stability</h3>
          <span class="badge">Dynamic</span>
        </div>
        <div class="exercise-list" id="setB"></div>
      </div>
      <div class="card">
        <div class="section-title">
          <h3 style="margin:0">Full body bodyweight</h3>
          <span class="badge">Strength</span>
        </div>
        <div class="exercise-list" id="setC"></div>
      </div>
    </section>

    <section class="card" aria-label="30 day abs">
      <div class="section-title">
        <h3 style="margin:0">30 day Abs track</h3>
        <span class="badge" id="absProgress">0 of 30</span>
      </div>
      <div id="absGrid" style="display:grid;grid-template-columns:repeat(10,1fr);gap:8px"></div>
      <div class="row" style="margin-top:10px">
        <button class="ghost" id="absReset">Reset track</button>
        <small class="muted">Days build from easier to spicier. One tap start from the grid.</small>
      </div>
    </section>

    <section class="timer">
      <div class="display">
        <div>
          <div class="time" id="time">00:30</div>
          <div class="stage" id="stage">Ready</div>
        </div>
      </div>
      <div class="progress"><div class="bar" id="bar"></div></div>
      <div class="controls-row">
        <button id="start" class="primary">Start</button>
        <button id="pause">Pause</button>
        <button id="skip">Skip</button>
        <button id="restart" class="ghost">Restart</button>
      </div>
      <div class="controls-row small">
        <label class="toggle"><input type="checkbox" id="autoAdvance" checked> Auto advance</label>
        <label class="toggle"><input type="checkbox" id="autoRest" checked> Auto rest</label>
        <label class="toggle"><input type="checkbox" id="countdown3" checked> 3 sec cue</label>
      </div>
      <details class="card">
        <summary><strong>Session notes</strong> and RPE</summary>
        <div style="margin-top:8px">
          <label class="small">How hard did it feel? RPE 1 to 10</label>
          <input id="rpe" type="range" min="1" max="10" value="6" style="width:100%">
          <textarea id="notes" placeholder="Any notes, niggles, wins..." rows="3" style="width:100%; margin-top:8px; background:rgba(255,255,255,.04); color:var(--ink); border:1px solid rgba(255,255,255,.1); border-radius:10px; padding:10px"></textarea>
          <div class="row" style="margin-top:8px">
            <button id="saveLog" class="primary">Save session</button>
            <span id="saveStatus" class="small" aria-live="polite"></span>
          </div>
        </div>
      </details>
    </section>
  </div>

  <footer>
    Built for quick, high quality bodyweight work. No accounts. Everything stays on your device.
  </footer>
</div>

<!-- Onboarding modal -->
<div id="onboard">
  <div class="sheet">
    <h3 style="margin-top:0">Set up your plan</h3>
    <p class="small">Pick a goal and your current level. You can change this any time.</p>
    <div id="step1">
      <p class="small">Goal</p>
      <div class="opt-grid">
        <div class="opt" data-goal="flat-abs">Flatter abs</div>
        <div class="opt" data-goal="strong-core">Stronger core</div>
        <div class="opt" data-goal="calisthenics">Calisthenics skills</div>
        <div class="opt" data-goal="fat-loss">Fat loss focus</div>
      </div>
      <div class="row">
        <button id="toStep2" class="primary" disabled>Continue</button>
        <button id="cancelOnboard" class="ghost">Cancel</button>
      </div>
    </div>
    <div id="step2" style="display:none">
      <div class="row">
        <div style="flex:1">
          <p class="small">Experience</p>
          <div class="opt-grid">
            <div class="opt" data-level="new">New</div>
            <div class="opt" data-level="trained">Trained</div>
            <div class="opt" data-level="advanced">Advanced</div>
          </div>
        </div>
        <div style="flex:1">
          <p class="small">Days per week</p>
          <div class="opt-grid">
            <div class="opt" data-days="3">3</div>
            <div class="opt" data-days="4">4</div>
            <div class="opt" data-days="5">5</div>
            <div class="opt" data-days="6">6</div>
          </div>
        </div>
      </div>
      <p class="small">Session length</p>
      <div class="opt-grid">
        <div class="opt" data-mins="10">10 minutes</div>
        <div class="opt" data-mins="20">20 minutes</div>
        <div class="opt" data-mins="30">30 minutes</div>
      </div>
      <div class="row">
        <button id="saveOnboard" class="primary" disabled>Save plan</button>
        <button id="backOnboard" class="ghost">Back</button>
      </div>
    </div>
  </div>
</div>

<script>
// Utility
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

// Data
const LIB = {
  // Ab foundations: control and bracing
  setA: [
    {id:"dead-bug", name:"Dead bug", cue:"Lower back flat. Exhale as you reach.", work:30, rest:15, ladder:["Toe taps","Dead bug","Dead bug with band"]},
    {id:"hollow-hold", name:"Hollow hold", cue:"Ribs down. Short shape. Breathe slow.", work:25, rest:20, ladder:["Tuck","One leg long","Full"]},
    {id:"side-plank", name:"Side plank", cue:"Top hip forward. Long line.", work:40, rest:20, ladder:["Knees","Feet","Star"]},
    {id:"glute-bridge", name:"Glute bridge", cue:"Squeeze at top, ribs down.", work:30, rest:15, ladder:["Double","Marching","Single leg"]},
  ],
  // Dynamic and stability mix
  setB: [
    {id:"plank-taps", name:"Plank shoulder taps", cue:"Wide feet. Keep hips steady.", work:30, rest:15, ladder:["High incline taps","Knee plank taps","Full taps"]},
    {id:"reverse-crunch", name:"Reverse crunch", cue:"Curl pelvis. Control down.", work:30, rest:20, ladder:["Knees bent","Straight legs","Add pause"]},
    {id:"mountain-climbers", name:"Mountain climbers", cue:"Knee to chest. Steady rhythm.", work:35, rest:20, ladder:["Slow","Quick","Cross body"]},
    {id:"bird-dog", name:"Bird dog", cue:"Reach long. Pause to kill wobble.", work:35, rest:15, ladder:["Short pause","3 sec pause","5 sec pause"]},
  ],
  // Full body bodyweight strength
  setC: [
    {id:"press-up", name:"Press-ups", cue:"Elbows 30 to 45 degrees. Body like a plank.", work:35, rest:25, ladder:["Incline press-ups","Knee press-ups","Full press-ups"]},
    {id:"squats", name:"Squats", cue:"Knees track toes. Chest tall.", work:40, rest:20, ladder:["Box squat","Air squat","Tempo 3-1-1"]},
    {id:"reverse-lunge", name:"Reverse lunges", cue:"Step back soft. Swap legs.", work:40, rest:20, ladder:["Assisted","Standard","Long step"]},
    {id:"hip-hinge", name:"Hip hinge", cue:"Hips back, flat back. Single leg if able.", work:35, rest:20, ladder:["Both legs","Single leg supported","Single leg"]},
  ],
};

const QUICK = {
  "Quick 10": {rounds:2, set:"setA"},
  "Solid 20": {rounds:3, set:"setB"},
  "Complete 30": {rounds:4, set:"setC"},
};

// State
let queue = [];
let idx = -1;
let timer = null;
let left = 0;
let total = 0;
let resting = false;
let beeps = initBeep();
let voice = window.speechSynthesis ? true : false;

// Storage
const store = {
  save(key,val){ localStorage.setItem(key, JSON.stringify(val)); },
  get(key, fallback){ try{ return JSON.parse(localStorage.getItem(key)) ?? fallback } catch{ return fallback } }
};

// Profile and plan from onboarding
let profile = store.get("profile", null);

const defaultPlan = () => {
  const days = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
  const picks = ["setA","setB","setC","rest","setA","setB","rest"];
  return days.map((d,i)=>({day:d, block:picks[i]}));
};
let plan = store.get("plan", defaultPlan());
renderPlan();

// Stats
let stats = store.get("stats", {sessions:0, streak:0, lastDay:null});
syncStatsUI();

// 30 day track
let absTrack = store.get("absTrack", {done:[], seed:1}); // done is array of day numbers
renderAbsTrack();

// Weekly challenges state
let challenges = store.get("chals", initChallenges());
renderChallenges();

// Build exercise lists with skills ladder buttons
for(const key of ["setA","setB","setC"]){
  const parent = document.getElementById(key);
  LIB[key].forEach(ex => parent.appendChild(exerciseRow(ex)));
}

function exerciseRow(ex){
  const el = document.createElement("div");
  el.className = "exercise";
  el.innerHTML = `
    <div class="icon" aria-hidden="true">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
        <circle cx="12" cy="6" r="3" fill="white" opacity=".9"/>
        <rect x="10.5" y="9" width="3" height="7" rx="1.5" fill="white" opacity=".9"/>
        <rect x="6" y="11" width="12" height="2.6" rx="1.3" fill="white" opacity=".7"/>
        <rect x="8" y="14" width="8" height="2.4" rx="1.2" fill="white" opacity=".5"/>
      </svg>
    </div>
    <div class="body">
      <p class="title">${ex.name}</p>
      <p class="meta">${ex.cue} â€¢ ${ex.work}s work, ${ex.rest}s rest</p>
    </div>
    <div style="display:flex;flex-direction:column;gap:6px">
      <button class="small" data-add='${JSON.stringify(ex).replace(/'/g,"&apos;")}'>Add</button>
      <button class="small" data-ladder='${JSON.stringify(ex.ladder).replace(/'/g,"&apos;")}'>Swap</button>
    </div>
  `;
  el.querySelector("[data-add]").addEventListener("click", e => {
    const exo = JSON.parse(e.target.getAttribute("data-add").replace(/&apos;/g,"'"));
    appendToQueue(exo);
  });
  el.querySelector("[data-ladder]").addEventListener("click", e => {
    const ladder = JSON.parse(e.target.getAttribute("data-ladder").replace(/&apos;/g,"'"));
    showLadder(e.target, ladder, chosen => {
      const exo = {...ex, name: chosen};
      appendToQueue(exo);
    });
  });
  return el;
}

function showLadder(anchor, ladder, onPick){
  closePop();
  const pop = document.createElement("div");
  pop.className = "pop";
  ladder.forEach(label => {
    const b = document.createElement("button");
    b.textContent = label;
    b.onclick = () => { onPick(label); closePop(); };
    pop.appendChild(b);
  });
  document.body.appendChild(pop);
  const r = anchor.getBoundingClientRect();
  pop.style.left = (r.left + window.scrollX) + "px";
  pop.style.top = (r.bottom + window.scrollY + 6) + "px";
  function closePop(){ if(pop.parentNode) pop.parentNode.removeChild(pop); document.removeEventListener("click", onDoc); }
  function onDoc(ev){ if(!pop.contains(ev.target) && ev.target !== anchor) closePop(); }
  setTimeout(()=> document.addEventListener("click", onDoc), 0);
}

// Plan
function renderPlan(){
  const ul = $("#planList");
  ul.innerHTML = "";
  plan.forEach((p,i)=>{
    const li = document.createElement("li");
    const label = p.block === "rest" ? "Rest" : prettyBlock(p.block);
    li.innerHTML = `<span><strong>${p.day}</strong></span><span>${label}</span>`;
    ul.appendChild(li);
  });
  const today = new Date();
  const todayIdx = (today.getDay()+6)%7; // Monday 0
  $("#nextUp").textContent = plan[todayIdx]?.block === "rest" ? "Rest" : prettyBlock(plan[todayIdx]?.block || "setA");
}

function prettyBlock(block){
  return block === "setA" ? "Ab foundations" : block === "setB" ? "Power & stability" : "Full body";
}

function syncStatsUI(){
  $("#sessions").textContent = stats.sessions;
  $("#streak").textContent = stats.streak;
}

// Queue helpers
function buildQueue(setKey, rounds, scale=1){
  queue = [];
  for(let r=1; r<=rounds; r++){
    for(const ex of LIB[setKey]){
      const w = Math.max(15, Math.round(ex.work*scale));
      const rest = Math.max(10, Math.round(ex.rest* (scale > 1 ? 0.95 : 1)));
      queue.push({type:"work", ...ex, name: ex.name, work:w, rest:rest, round:r});
      queue.push({type:"rest", name:"Rest", cue:"Breathe low. Shake out.", work:rest, rest:0, round:r});
    }
    if(r < rounds){
      queue.push({type:"rest", name:"Round rest", cue:"Walk. Big breaths.", work:25, rest:0, round:r});
    }
  }
  idx = -1;
  updateStage("Ready");
  updateTime(0,0);
  updateBar(0);
}

function appendToQueue(ex){
  if(queue.length === 0){ buildQueue("setA", 1); }
  queue.push({type:"work", ...ex, round:"+"});
  queue.push({type:"rest", name:"Rest", cue:"Breathe low. Shake out.", work:ex.rest || 15, rest:0, round:"+"});
  $("#stage").textContent = "Appended " + ex.name;
}

function startQuick(label){
  const cfg = QUICK[label];
  const scale = profile && profile.mins ? (profile.mins/20) : (label.includes("10")?0.85:label.includes("30")?1.15:1);
  buildQueue(cfg.set, cfg.rounds, scale);
  speak(label + ". " + prettyBlock(cfg.set));
  startTimer();
}

function shufflePlan(){
  const blocks = ["setA","setB","setC","rest","setA","setB","rest"];
  plan = plan.map((p,i)=> ({day:p.day, block: blocks.sort(()=>Math.random()-0.5)[i]} ));
  store.save("plan", plan);
  renderPlan();
}

function startToday(){
  const today = new Date();
  const todayIdx = (today.getDay()+6)%7;
  const block = plan[todayIdx]?.block || "setA";
  const cfg = {set:block, rounds: block === "setC" ? 4 : 3};
  const mins = profile?.mins || 20;
  const scale = mins>=30?1.15: mins<=10?0.85:1;
  buildQueue(cfg.set, cfg.rounds, scale);
  speak("Starting " + prettyBlock(cfg.set));
  startTimer();
}

// 30 day track logic
function renderAbsTrack(){
  const grid = $("#absGrid");
  grid.innerHTML = "";
  const done = new Set(absTrack.done);
  for(let d=1; d<=30; d++){
    const b = document.createElement("button");
    b.textContent = d;
    b.style.padding = "8px";
    b.style.borderRadius = "10px";
    b.style.border = "1px solid rgba(255,255,255,.15)";
    b.style.background = done.has(d) ? "linear-gradient(135deg, var(--brand), var(--accent))" : "rgba(255,255,255,.04)";
    b.style.color = done.has(d) ? "#0b1020" : "var(--ink)";
    b.title = done.has(d) ? "Completed" : "Start day " + d;
    b.disabled = false;
    b.addEventListener("click", ()=> startAbsDay(d));
    grid.appendChild(b);
  }
  $("#absProgress").textContent = `${absTrack.done.length} of 30`;
}

function startAbsDay(day){
  // Scale and selection grow across the month
  const week = Math.ceil(day/7);
  const set = week<=2 ? "setA" : week<=4 ? "setB" : "setC";
  const rounds = week<=2 ? 2 : week<=4 ? 3 : 4;
  const scale = 0.9 + (day-1) * (0.3/29); // from 0.9 to 1.2
  buildQueue(set, rounds, scale);
  speak("Thirty day track. Day " + day + ". " + prettyBlock(set));
  startTimer();
}

// Timer engine
function startTimer(){
  if(queue.length === 0){
    buildQueue("setA", 2);
  }
  if(idx === -1) idx = 0;
  tickSetup();
  if(timer) clearInterval(timer);
  timer = setInterval(tick, 100);
}

function tickSetup(){
  const step = queue[idx];
  resting = step.type !== "work";
  total = step.work * 1000;
  left = total;
  updateStage(`${step.name} ${resting ? "" : "(Round " + step.round + ")"}`);
  if($("#countdown3").checked && !resting){
    countdown3(()=>{
      if($("#soundToggle").checked) beep();
      speak(step.name + ". " + (step.cue || ""));
    });
  }else{
    if($("#soundToggle").checked) beep();
    speak(step.name + (step.cue ? ". " + step.cue : ""));
  }
  updateTime();
  updateBar(0);
}

function tick(){
  left -= 100;
  if(left < 0) left = 0;
  updateTime();
  updateBar(1 - left/total);
  if(left === 0){
    if($("#autoAdvance").checked){
      nextStep();
    }else{
      clearInterval(timer); timer = null;
    }
  }
}

function nextStep(){
  idx++;
  if(idx >= queue.length){
    clearInterval(timer); timer = null;
    finishSession();
    return;
  }
  if(!$("#autoRest").checked && queue[idx].type !== "work"){
    idx++; // skip rest
  }
  if(idx >= queue.length){
    clearInterval(timer); timer = null;
    finishSession();
    return;
  }
  tickSetup();
}

function pauseTimer(){
  if(!timer) return;
  clearInterval(timer); timer = null;
}

function restartTimer(){
  if(timer) clearInterval(timer);
  idx = -1;
  updateStage("Ready");
  updateTime(0,0);
  updateBar(0);
}

function finishSession(){
  updateStage("Done. Nice work.");
  updateTime(0,0);
  updateBar(1);
  if($("#soundToggle").checked){ chime(); }
  trackComplete();
}

// UI helpers
function updateStage(txt){ $("#stage").textContent = txt; }
function updateTime(){
  const ms = left;
  const s = Math.ceil(ms/1000);
  const mm = String(Math.floor(s/60)).padStart(2,"0");
  const ss = String(s%60).padStart(2,"0");
  $("#time").textContent = `${mm}:${ss}`;
}
function updateBar(p){ $("#bar").style.width = `${Math.max(0,Math.min(1,p))*100}%`; }

// Beeps
function initBeep(){
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    return {ctx};
  }catch{ return null }
}
function beep(){
  if(!beeps) return;
  const o = beeps.ctx.createOscillator();
  const g = beeps.ctx.createGain();
  o.type = "sine";
  o.frequency.setValueAtTime(880, beeps.ctx.currentTime);
  g.gain.setValueAtTime(0.0001, beeps.ctx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.2, beeps.ctx.currentTime + 0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, beeps.ctx.currentTime + 0.15);
  o.connect(g).connect(beeps.ctx.destination);
  o.start(); o.stop(beeps.ctx.currentTime + 0.16);
}
function chime(){
  if(!beeps) return;
  const t = beeps.ctx.currentTime;
  const notes = [659,784,987];
  notes.forEach((f,i)=>{
    const o = beeps.ctx.createOscillator();
    const g = beeps.ctx.createGain();
    o.frequency.value = f;
    o.type = "triangle";
    g.gain.value = 0.0001;
    o.connect(g).connect(beeps.ctx.destination);
    o.start(t + i*0.12);
    g.gain.exponentialRampToValueAtTime(0.3, t + i*0.12 + 0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, t + i*0.12 + 0.25);
    o.stop(t + i*0.12 + 0.28);
  });
}

// Voice
function speak(text){
  if(!$("#voiceToggle").checked) return;
  if(!window.speechSynthesis) return;
  const u = new SpeechSynthesisUtterance(text);
  u.rate = 1.05; u.pitch = 1;
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(u);
}

// Countdown 3..2..1
function countdown3(done){
  let c = 3;
  const iv = setInterval(()=>{
    $("#stage").textContent = "Starting in " + c;
    if($("#soundToggle").checked) beep();
    c--;
    if(c < 0){ clearInterval(iv); done(); }
  }, 500);
}

// Logging and progression and challenges
function trackComplete(){
  const today = new Date();
  const key = today.toISOString().slice(0,10);
  // streak
  if(stats.lastDay){
    const last = new Date(stats.lastDay);
    const diff = Math.floor((today - last)/86400000);
    if(diff === 1) stats.streak += 1;
    else if(diff > 1) stats.streak = 1;
  }else{
    stats.streak = 1;
  }
  stats.sessions += 1;
  stats.lastDay = key;
  store.save("stats", stats);
  syncStatsUI();

  // mark 30 day track if a day was started
  if(currentAbsDay){
    if(!absTrack.done.includes(currentAbsDay)){
      absTrack.done.push(currentAbsDay);
      store.save("absTrack", absTrack);
      renderAbsTrack();
    }
    currentAbsDay = null;
  }

  // challenge progression
  bumpChallengesFromQueue(queue);
  renderChallenges();
}

function saveSession(){
  const rpe = Number($("#rpe").value);
  const notes = $("#notes").value.trim();
  const stamp = new Date().toISOString();
  const summary = {
    id: stamp,
    rpe, notes,
    steps: queue.map(q=>({type:q.type,name:q.name,work:q.work,rest:q.rest,round:q.round}))
  };
  const hist = store.get("history", []);
  hist.unshift(summary);
  store.save("history", hist);
  $("#saveStatus").textContent = "Saved";
  setTimeout(()=> $("#saveStatus").textContent = "", 1500);
}

// History modal
function showHistory(){
  const hist = store.get("history", []);
  const win = window.open("", "_blank");
  if(!win){
    alert("Please allow pop ups for history");
    return;
  }
  win.document.write(`
    <html><head><title>History</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      body{font-family: ui-sans-serif, system-ui, -apple-system; background:#0f1115; color:#e9ecf1; margin:0; padding:20px}
      .item{border:1px solid rgba(255,255,255,.15); border-radius:12px; padding:12px; margin-bottom:10px; background:rgba(255,255,255,.04)}
      small{color:#a8b0bf}
      ul{margin:8px 0 0 18px}
      .meta{display:flex;gap:10px}
    </style></head><body>
    <h2>Session history</h2>
    ${hist.length === 0 ? "<p>No history yet.</p>" : hist.map(h => `
      <div class="item">
        <div class="meta"><small>${new Date(h.id).toLocaleString()}</small><small>RPE ${h.rpe}</small></div>
        ${h.notes ? `<p>${escapeHtml(h.notes)}</p>` : ""}
        <ul>
          ${h.steps.filter(s=>s.type==="work").map(s=> `<li>${s.name} ${s.work}s ${s.round ? "(Round " + s.round + ")" : ""}</li>`).join("")}
        </ul>
      </div>
    `).join("")}
    </body></html>
  `);
  win.document.close();
}

// Escape
function escapeHtml(s){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

// Onboarding
function openOnboard(){
  $("#onboard").style.display = "flex";
}
function closeOnboard(){
  $("#onboard").style.display = "none";
}
function initOnboard(){
  if(!profile){ openOnboard(); }
  let goal = null, level = null, days = null, mins = null;
  $$("#step1 .opt").forEach(o => o.addEventListener("click", () => {
    $$("#step1 .opt").forEach(x => x.classList.remove("active"));
    o.classList.add("active");
    goal = o.dataset.goal;
    $("#toStep2").disabled = !goal;
  }));
  $("#toStep2").addEventListener("click", ()=>{
    $("#step1").style.display = "none";
    $("#step2").style.display = "block";
  });
  $("#backOnboard").addEventListener("click", ()=>{
    $("#step2").style.display = "none";
    $("#step1").style.display = "block";
  });
  $("#cancelOnboard").addEventListener("click", closeOnboard);

  $$("#step2 .opt").forEach(o => o.addEventListener("click", () => {
    if(o.dataset.level){ $$("#[data-level]").forEach(x=>x.classList.remove("active")); }
    if(o.dataset.days){ $$("#[data-days]").forEach(x=>x.classList.remove("active")); }
    if(o.dataset.mins){ $$("#[data-mins]").forEach(x=>x.classList.remove("active")); }
    o.classList.toggle("active");
    if(o.dataset.level) level = o.dataset.level;
    if(o.dataset.days) days = Number(o.dataset.days);
    if(o.dataset.mins) mins = Number(o.dataset.mins);
    $("#saveOnboard").disabled = !(goal && level && days && mins);
  }));

  $("#saveOnboard").addEventListener("click", ()=>{
    profile = {goal, level, days, mins};
    store.save("profile", profile);
    // build plan from profile
    plan = makePlanFromProfile(profile);
    store.save("plan", plan);
    renderPlan();
    closeOnboard();
    speak("Plan saved");
  });
}

function makePlanFromProfile(p){
  const days = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
  let pattern = [];
  if(p.days === 3) pattern = ["setA","setC","setB","rest","setA","rest","setB"];
  if(p.days === 4) pattern = ["setA","setC","rest","setB","setA","rest","setB"];
  if(p.days === 5) pattern = ["setA","setC","setB","rest","setA","rest","setB"];
  if(p.days >= 6) pattern = ["setA","setC","setB","setA","setC","rest","setB"];
  return days.map((d,i)=>({day:d, block:pattern[i] || "rest"}));
}

// Weekly challenges
function initChallenges(){
  return {
    weekId: weekKey(new Date()),
    sessionTarget: 4,
    sessionDone: 0,
    plankSecsTarget: 300,
    plankSecsDone: 0,
    badges: []
  };
}

function weekKey(d){
  const copy = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  copy.setUTCDate(copy.getUTCDate() + 4 - (copy.getUTCDay()||7));
  const yearStart = new Date(Date.UTC(copy.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((copy - yearStart) / 86400000) + 1)/7);
  return copy.getUTCFullYear() + "-W" + weekNo;
}

function ensureWeek(){
  const nowKey = weekKey(new Date());
  if(challenges.weekId !== nowKey){
    challenges = initChallenges();
    challenges.weekId = nowKey;
    store.save("chals", challenges);
  }
}

function bumpChallengesFromQueue(steps){
  ensureWeek();
  challenges.sessionDone += 1;
  // Count plank and hollow time
  let add = 0;
  steps.forEach(s => {
    if(s.type === "work"){
      const n = s.name.toLowerCase();
      if(n.includes("plank") || n.includes("hollow")) add += Number(s.work || 0);
    }
  });
  challenges.plankSecsDone += add;
  // badges
  if(challenges.sessionDone >= challenges.sessionTarget && !challenges.badges.includes("Consistency")){
    challenges.badges.push("Consistency");
  }
  if(challenges.plankSecsDone >= challenges.plankSecsTarget && !challenges.badges.includes("Core steel")){
    challenges.badges.push("Core steel");
  }
  store.save("chals", challenges);
}

function renderChallenges(){
  ensureWeek();
  const ul = $("#challengeList");
  ul.innerHTML = "";
  const a = document.createElement("li");
  a.innerHTML = `<span>Sessions this week</span><span>${challenges.sessionDone} of ${challenges.sessionTarget}</span>`;
  const b = document.createElement("li");
  b.innerHTML = `<span>Plank and hollow seconds</span><span>${challenges.plankSecsDone} of ${challenges.plankSecsTarget}</span>`;
  ul.appendChild(a); ul.appendChild(b);
  if(challenges.badges.length){
    const c = document.createElement("li");
    c.innerHTML = `<span>Badges</span><span>${challenges.badges.join(", ")}</span>`;
    ul.appendChild(c);
  }
}

// Audio only toggle
$("#audioOnly").addEventListener("change", e => {
  document.body.classList.toggle("audio-only", e.target.checked);
});

// History and reset and set-up
$("#saveLog").addEventListener("click", saveSession);
$("#historyBtn").addEventListener("click", showHistory);
$("#resetBtn").addEventListener("click", ()=>{
  if(confirm("Reset all data and plan?")){
    localStorage.clear();
    plan = defaultPlan();
    stats = {sessions:0, streak:0, lastDay:null};
    absTrack = {done:[], seed:1};
    challenges = initChallenges();
    profile = null;
    renderPlan(); syncStatsUI(); renderAbsTrack(); renderChallenges(); restartTimer();
    openOnboard();
  }
});
$("#onboardBtn").addEventListener("click", openOnboard);

// Quick starts and plan edits
$("#quick10").addEventListener("click", ()=> startQuick("Quick 10"));
$("#quick20").addEventListener("click", ()=> startQuick("Solid 20"));
$("#quick30").addEventListener("click", ()=> startQuick("Complete 30"));
$("#shuffle").addEventListener("click", shufflePlan);
$("#startToday").addEventListener("click", startToday);
$("#buildBtn").addEventListener("click", ()=>{
  const pick = prompt("Build a week. Enter setA, setB, setC, or rest for Mon..Sun separated by commas.\nExample: setA,setB,rest,setC,rest,setA,setB", plan.map(p=>p.block).join(","));
  if(!pick) return;
  const arr = pick.split(",").map(s=>s.trim());
  if(arr.length !== 7) { alert("Need 7 items"); return; }
  plan = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"].map((d,i)=>({day:d, block: arr[i] || "rest"}));
  store.save("plan", plan);
  renderPlan();
});

// Timer controls
$("#start").addEventListener("click", startTimer);
$("#pause").addEventListener("click", pauseTimer);
$("#skip").addEventListener("click", nextStep);
$("#restart").addEventListener("click", restartTimer);

// Start with a short queue
buildQueue("setA", 1);

// Onboard
initOnboard();

// Improve accessible labels
$("#voiceToggle").addEventListener("change", e => {
  if(e.target.checked && !window.speechSynthesis){
    alert("Voice cues are not supported in this browser.");
    e.target.checked = false;
  }
});

// track when a 30 day session is started
let currentAbsDay = null;
function startAbsDay(d){
  currentAbsDay = d;
  // Scale and selection grow across the month
  const week = Math.ceil(d/7);
  const set = week<=2 ? "setA" : week<=4 ? "setB" : "setC";
  const rounds = week<=2 ? 2 : week<=4 ? 3 : 4;
  const scale = 0.9 + (d-1) * (0.3/29);
  buildQueue(set, rounds, scale);
  speak("Thirty day track. Day " + d + ". " + prettyBlock(set));
  startTimer();
}
</script>
</body>
</html>
