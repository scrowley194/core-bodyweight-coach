import React, { useState, useEffect, useRef } from 'react';
import { 
  Flame, Trophy, Dumbbell, TrendingUp, 
  Utensils, Play, Pause, ChevronRight,
  CheckCircle2, X, Footprints, Moon,
  Zap, BarChart3, Calendar, History,
  LayoutDashboard, Layers, Droplets, Settings,
  ArrowRight, Scale, RotateCcw, Ruler, Activity,
  Calculator, User, Star, Pill, Sofa, ClipboardCheck,
  TrendingDown, AlertTriangle, PartyPopper, Brain, Shield, Info, HelpCircle,
  ChefHat, BookOpen
} from 'lucide-react';

// --- VISUAL ASSETS (Simple SVG Components for Form) ---
const Icons = {
  Pushup: () => (
    <svg viewBox="0 0 100 100" className="w-16 h-16 text-blue-500 fill-current opacity-80 mx-auto">
      <circle cx="85" cy="25" r="5" />
      <path d="M85 30 L70 45 L30 45 L10 60" stroke="currentColor" strokeWidth="3" fill="none" />
      <path d="M70 45 L70 55 L90 55" stroke="currentColor" strokeWidth="3" fill="none" />
      <rect x="5" y="60" width="90" height="2" fill="currentColor" opacity="0.3" />
    </svg>
  ),
  Squat: () => (
    <svg viewBox="0 0 100 100" className="w-16 h-16 text-blue-500 fill-current opacity-80 mx-auto">
      <circle cx="50" cy="20" r="5" />
      <path d="M50 25 L50 45 L30 65 L30 90" stroke="currentColor" strokeWidth="3" fill="none" />
      <path d="M50 45 L70 65 L70 90" stroke="currentColor" strokeWidth="3" fill="none" />
      <rect x="20" y="90" width="60" height="2" fill="currentColor" opacity="0.3" />
    </svg>
  ),
  Plank: () => (
    <svg viewBox="0 0 100 100" className="w-16 h-16 text-blue-500 fill-current opacity-80 mx-auto">
      <circle cx="80" cy="45" r="5" />
      <path d="M80 50 L20 50" stroke="currentColor" strokeWidth="3" fill="none" />
      <path d="M80 50 L75 60 L85 60" stroke="currentColor" strokeWidth="3" fill="none" />
      <path d="M20 50 L20 60" stroke="currentColor" strokeWidth="3" fill="none" />
      <rect x="10" y="60" width="80" height="2" fill="currentColor" opacity="0.3" />
    </svg>
  ),
  Generic: () => (
    <svg viewBox="0 0 100 100" className="w-16 h-16 text-blue-500 fill-current opacity-80 mx-auto">
      <circle cx="50" cy="50" r="40" stroke="currentColor" strokeWidth="2" fill="none"/>
      <path d="M50 30 L50 70 M30 50 L70 50" stroke="currentColor" strokeWidth="2" />
    </svg>
  )
};

const AbsRecompLegacy = () => {
  // --- STATE ---
  const [appData, setAppData] = useState({
    userProfile: {
      name: '',
      weight: '', 
      height: '',
      age: '', 
      gender: 'male', 
      onboarded: false,
    },
    exerciseHistory: {}, 
    measurements: [], 
    dailyLog: {
      date: null,
      protein: 0,
      calories: 0, 
      sleep: 0,
      steps: false,
      water: 0,
      creatine: false,
      isRestDay: false
    },
    workoutStreak: 0,
    habitStreak: 0,
    totalWorkouts: 0,
    perfectDays: 0, 
    phase: 1,
    completedWorkouts: [], 
    settings: { sound: true }
  });

  const [view, setView] = useState('onboarding');
  const [activeTab, setActiveTab] = useState('train');
  const [showSettings, setShowSettings] = useState(false);
  const [showWarmup, setShowWarmup] = useState(false);
  const [infoModal, setInfoModal] = useState(null);
  const [morningReport, setMorningReport] = useState(null);
  const [showConfetti, setShowConfetti] = useState(false); 
  const [showMealGuide, setShowMealGuide] = useState(false); 

  // WORKOUT STATE
  const [activeWorkout, setActiveWorkout] = useState(null);
  const [exerciseIndex, setExerciseIndex] = useState(0);
  const [currentSet, setCurrentSet] = useState(1);
  const [totalSets, setTotalSets] = useState(3);
  const [timer, setTimer] = useState(0);
  const [isResting, setIsResting] = useState(false);
  const [isPaused, setIsPaused] = useState(false);
  const [showQuit, setShowQuit] = useState(false);
  const [showTimedInput, setShowTimedInput] = useState(false); // Manages visibility of RPE for timed sets
  
  // INPUT STATES
  const [repInput, setRepInput] = useState('');
  const [rpeInput, setRpeInput] = useState(null); 
  
  const [waistInput, setWaistInput] = useState('');
  const [weightInput, setWeightInput] = useState('');
  const [neckInput, setNeckInput] = useState('');
  const [hipInput, setHipInput] = useState('');
  
  const timerRef = useRef(null);

  // --- AUDIO ---
  const playTone = (type) => {
    if (!appData.settings.sound) return;
    try {
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      if (!AudioContext) return;
      const ctx = new AudioContext();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);
      const now = ctx.currentTime;
      
      const tones = {
        tick: [800, 0.05],
        start: [440, 0.3],
        success: [600, 0.4],
        perfect: [500, 0.5]
      };

      if (type === 'celebrate') {
        [440, 554, 659, 880].forEach((freq, i) => {
            const osc2 = ctx.createOscillator();
            const gain2 = ctx.createGain();
            osc2.connect(gain2);
            gain2.connect(ctx.destination);
            osc2.frequency.value = freq;
            gain2.gain.setValueAtTime(0.1, now + (i*0.1));
            gain2.gain.exponentialRampToValueAtTime(0.01, now + 1);
            osc2.start(now + (i*0.1));
            osc2.stop(now + 1);
        });
      } else {
        const [freq, dur] = tones[type] || [440, 0.1];
        osc.frequency.setValueAtTime(freq, now);
        if(type === 'start') osc.frequency.exponentialRampToValueAtTime(880, now + 0.1);
        gain.gain.setValueAtTime(0.1, now);
        osc.start(now);
        osc.stop(now + dur);
      }
    } catch (e) { console.error(e); }
  };

  // --- CALCULATORS ---
  const calculateTargets = (profile = appData.userProfile) => {
    const w = parseFloat(profile.weight || 70); 
    const h = parseFloat(profile.height || 175); 
    const a = parseFloat(profile.age || 30); 
    const isMale = profile.gender === 'male';
    if (isNaN(w) || isNaN(h)) return { calorieTarget: 2000, proteinTarget: 150 };
    let bmr = (10 * w) + (6.25 * h) - (5 * a) + (isMale ? 5 : -161);
    const tdee = bmr * 1.55; 
    return { calorieTarget: Math.round(tdee * 0.85), proteinTarget: Math.round(w * 2.2) };
  };

  const calculateBodyFat = (waist, neck, hip, height, gender) => {
      if (!waist || !neck || !height) return null;
      if (gender === 'female' && !hip) return null;
      let bf = 0;
      if (gender === 'male') bf = 495 / (1.0324 - 0.19077 * Math.log10(waist - neck) + 0.15456 * Math.log10(height)) - 450;
      else bf = 495 / (1.29579 - 0.35004 * Math.log10(waist + hip - neck) + 0.22100 * Math.log10(height)) - 450;
      return bf > 0 ? bf.toFixed(1) : null;
  };

  const { calorieTarget, proteinTarget } = calculateTargets();

  const isPerfectDayLive = () => {
      const log = appData.dailyLog;
      return (
          log.protein >= proteinTarget * 0.9 &&
          log.calories > 1200 && log.calories <= calorieTarget + 200 &&
          log.sleep >= 7 && log.water >= 6 && log.steps && log.creatine
      );
  };

  // --- PERSISTENCE & AUTO-LOGIC ---
  useEffect(() => {
    const saved = localStorage.getItem('recomp-legacy-data');
    if (saved) {
      const parsed = JSON.parse(saved);
      const today = new Date().toISOString().split('T')[0];
      
      if (parsed.dailyLog.date !== today) {
        // Morning Logic
        const { proteinTarget, calorieTarget } = calculateTargets(parsed.userProfile);
        const log = parsed.dailyLog;
        const prevDate = parsed.dailyLog.date;
        
        const isPerfect = log.protein >= proteinTarget * 0.9 && log.steps && log.sleep >= 7 && log.water >= 6 && log.creatine && (log.calories > 1200 && log.calories <= calorieTarget + 200);
        const isHabitSuccess = log.protein >= proteinTarget * 0.9 || log.steps; 

        if (prevDate) {
            if (isPerfect) {
                parsed.perfectDays += 1;
                parsed.habitStreak += 1;
                setMorningReport({ title: "Perfect Day! ðŸŒŸ", text: "You did it all. This is the difference between dreaming and achieving." });
            } else if (isHabitSuccess) {
                parsed.habitStreak += 1;
                setMorningReport({ title: "Streak Alive ðŸ”¥", text: "Momentum maintained. Aim for 'Perfect' today." });
            } else {
                parsed.habitStreak = 0;
                setMorningReport({ title: "Fresh Start ðŸŒ…", text: "Yesterday is gone. Win today." });
            }
        }

        parsed.dailyLog = { date: today, protein: 0, calories: 0, sleep: 0, steps: false, water: 0, creatine: false, isRestDay: false };
      }
      
      if (!parsed.measurements) parsed.measurements = [];
      if (!parsed.exerciseHistory) parsed.exerciseHistory = {};
      
      setAppData(parsed);
      if (parsed.userProfile.onboarded) setView('main');
    }
  }, []);

  useEffect(() => {
    if (appData.userProfile.onboarded) {
      localStorage.setItem('recomp-legacy-data', JSON.stringify(appData));
    }
  }, [appData]);

  useEffect(() => {
      if (isPerfectDayLive() && !showConfetti) {
          setShowConfetti(true);
          playTone('celebrate');
          setTimeout(() => setShowConfetti(false), 3000);
      }
  }, [appData.dailyLog]);

  // --- EVOLUTION ENGINE & VISUALS ---
  const getSmartTarget = (baseId, defaultTarget) => {
      const history = appData.exerciseHistory[baseId];
      if (!history) return defaultTarget;
      return `${history.nextTarget || defaultTarget} reps`; 
  };

  const getExerciseVersion = (baseId) => {
    const history = appData.exerciseHistory;
    const getLevel = (id) => (history[id]?.maxReps || 0);
    
    if (baseId === 'pushups') {
      if (getLevel('pushups_v3') > 20) return { id: 'pushups_v3', name: 'Decline Push-ups + Weight', target: 'Failure', desc: 'Add backpack with weight.', level: 4, type: 'push', icon: Icons.Pushup };
      if (getLevel('pushups_v1') > 30) return { id: 'pushups_v3', name: 'Decline Push-ups', target: getSmartTarget('pushups_v3', 15), desc: 'Feet on chair. Target upper chest.', level: 3, type: 'push', icon: Icons.Pushup };
      if (getLevel('pushups_v1') > 20) return { id: 'pushups_v2', name: 'Diamond Push-ups', target: getSmartTarget('pushups_v2', 12), desc: 'Hands touching. Target triceps.', level: 2, type: 'push', icon: Icons.Pushup };
      return { id: 'pushups_v1', name: 'Slow Push-ups', target: getSmartTarget('pushups_v1', 10), desc: '3s down, 1s up. Control is key.', level: 1, type: 'push', icon: Icons.Pushup };
    }
    if (baseId === 'squats') {
      if (getLevel('squats_v1') > 40) return { id: 'squats_v3', name: 'Bulgarian Split Squats', target: getSmartTarget('squats_v3', 12), desc: 'One foot on chair behind.', level: 3, type: 'leg', icon: Icons.Squat };
      if (getLevel('squats_v1') > 25) return { id: 'squats_v2', name: 'Jump Squats', target: getSmartTarget('squats_v2', 20), desc: 'Explosive power.', level: 2, type: 'leg', icon: Icons.Squat };
      return { id: 'squats_v1', name: 'Pause Squats', target: getSmartTarget('squats_v1', 15), desc: 'Hold bottom 2s. No bouncing.', level: 1, type: 'leg', icon: Icons.Squat };
    }
    
    // Fallbacks
    if (baseId === 'plank') return { id: 'plank_v1', name: 'RKC Plank', target: `${30 + (Math.floor(appData.totalWorkouts/10)*10)}s`, desc: 'Squeeze glutes and fists hard.', type:'time', duration: 30 + (Math.floor(appData.totalWorkouts/10)*10), level: 1, icon: Icons.Plank };
    if (baseId === 'glute') return { id: 'glute_v1', name: 'Glute Bridges', target: getSmartTarget('glute_v1', 20), desc: 'Squeeze at top. Do not arch back.', level: 1, type: 'leg', icon: Icons.Generic };
    if (baseId === 'lunges') return { id: 'lunges_v1', name: 'Reverse Lunges', target: getSmartTarget('lunges_v1', 12), desc: 'Step back far. Vertical shin.', level: 1, type: 'leg', icon: Icons.Generic };
    if (baseId === 'deadbug') return { id: 'deadbug', name: 'Dead Bugs', target: '60s', desc: 'Lower back glued to floor.', type:'time', duration: 60, level: 1, icon: Icons.Generic };
    if (baseId === 'snow_angels') return { id: 'snow_angels', name: 'Prone Snow Angels', target: getSmartTarget('snow_angels', 15), desc: 'Lying on belly. Swim arms.', level: 1, type: 'back', icon: Icons.Generic };
    if (baseId === 'bird_dog') return { id: 'bird_dog', name: 'Bird Dogs', target: '60s', desc: 'No hip wobble.', type:'time', duration: 60, level: 1, icon: Icons.Generic };

    return { id: baseId, name: baseId, target: '10', desc: '', level: 1, icon: Icons.Generic };
  };

  const prepareWorkout = () => {
    const isDeload = (appData.totalWorkouts + 1) % 12 === 0;
    const isRoutineA = appData.totalWorkouts % 2 === 0;
    const routine = {
        name: isDeload ? "Deload Week" : (isRoutineA ? "Anterior Chain" : "Posterior Chain"),
        isDeload: isDeload,
        exercises: isRoutineA 
            ? [getExerciseVersion('pushups'), getExerciseVersion('squats'), getExerciseVersion('deadbug'), getExerciseVersion('plank')]
            : [getExerciseVersion('glute'), getExerciseVersion('snow_angels'), getExerciseVersion('lunges'), getExerciseVersion('bird_dog')]
    };
    setActiveWorkout({ ...routine, startTime: Date.now() });
    setShowWarmup(true);
  };

  const startActualWorkout = () => {
    setShowWarmup(false);
    setExerciseIndex(0);
    setCurrentSet(1);
    setTotalSets(activeWorkout.isDeload ? 2 : 3); 
    setView('workout');
    setIsResting(false);
    setRepInput('');
    setRpeInput(null);
    setShowTimedInput(false);
    if (activeWorkout.exercises[0].type === 'time') setTimer(activeWorkout.exercises[0].duration);
    playTone('start');
  };

  // --- TIMER & REP HANDLERS ---
  useEffect(() => {
    if (view === 'workout' && !isPaused && (isResting || activeWorkout?.exercises[exerciseIndex].type === 'time')) {
        timerRef.current = setInterval(() => {
          setTimer(prev => {
            if (prev <= 1) { handleTimerComplete(); return 0; }
            if (prev <= 4) playTone('tick');
            return prev - 1;
          });
        }, 1000);
    }
    return () => clearInterval(timerRef.current);
  }, [view, isPaused, isResting, exerciseIndex, activeWorkout]);

  const handleTimerComplete = () => {
    if (isResting) {
      playTone('start');
      setIsResting(false);
      if (currentSet < totalSets) {
        setCurrentSet(p => p + 1); setRepInput(''); setRpeInput(null); setShowTimedInput(false);
        if (activeWorkout.exercises[exerciseIndex].type === 'time') setTimer(activeWorkout.exercises[exerciseIndex].duration);
      } else advanceExercise();
    } else {
      playTone('success');
      // Always show input screen after a timer finishes
      if (activeWorkout.exercises[exerciseIndex].type === 'time') {
          setShowTimedInput(true);
      } else {
          startRest();
      }
    }
  };

  const handleRepComplete = () => {
    const ex = activeWorkout.exercises[exerciseIndex];
    let reps = parseInt(repInput);
    if (isNaN(reps) && ex.type === 'time') reps = ex.duration; 
    if (isNaN(reps)) reps = 0;

    let nextTarget = reps;
    if (rpeInput === 'easy') nextTarget = Math.floor(reps * 1.2); 
    else if (rpeInput === 'good') nextTarget = reps + 1; 

    setAppData(prev => ({
      ...prev,
      exerciseHistory: {
        ...prev.exerciseHistory,
        [ex.id]: {
            maxReps: Math.max(prev.exerciseHistory[ex.id]?.maxReps || 0, reps),
            nextTarget: nextTarget 
        }
      }
    }));
    playTone('success');
    setShowTimedInput(false);
    startRest();
  };

  const startRest = () => {
    if (exerciseIndex >= activeWorkout.exercises.length - 1 && currentSet >= totalSets) { finishWorkout(); return; }
    setIsResting(true);
    setTimer(currentSet === totalSets ? 60 : 45); 
  };

  const advanceExercise = () => {
    const nextIndex = exerciseIndex + 1;
    if (nextIndex < activeWorkout.exercises.length) {
        setExerciseIndex(nextIndex); setCurrentSet(1); setRepInput(''); setRpeInput(null); setShowTimedInput(false);
        if (activeWorkout.exercises[nextIndex].type === 'time') setTimer(activeWorkout.exercises[nextIndex].duration);
    } else finishWorkout();
  };

  const finishWorkout = () => {
    const xp = 150 + (totalSets * 40);
    setAppData(prev => ({
      ...prev,
      totalWorkouts: prev.totalWorkouts + 1,
      xp: prev.xp + xp,
      workoutStreak: prev.workoutStreak + 1,
      habitStreak: prev.habitStreak + 1,
      completedWorkouts: [...prev.completedWorkouts, { date: new Date().toISOString().split('T')[0], xp }]
    }));
    setView('summary');
  };

  // --- UI COMPONENTS ---
  
  const TrainTab = () => (
    <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
        <div className={`rounded-3xl p-6 shadow-xl relative overflow-hidden group ${activeWorkout?.isDeload ? 'bg-purple-900' : 'bg-gradient-to-br from-blue-800 to-indigo-900'}`}>
            <div className="relative z-10">
                <div className="flex justify-between items-start mb-4">
                    <span className="bg-white/10 backdrop-blur px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider text-white border border-white/20">
                        {(appData.totalWorkouts + 1) % 12 === 0 ? 'Recovery Week' : (appData.totalWorkouts % 2 === 0 ? 'Routine A' : 'Routine B')}
                    </span>
                    <span className="text-xs font-bold text-green-300 flex items-center gap-1"><Zap className="w-3 h-3"/> {(appData.totalWorkouts + 1) % 12 === 0 ? '8 Sets (Deload)' : '12 Sets'}</span>
                </div>
                {appData.dailyLog.isRestDay ? (
                    <div>
                        <h2 className="text-3xl font-bold text-white mb-2">Rest & Grow</h2>
                        <p className="text-blue-100 text-xs mb-6 max-w-[90%] opacity-90 leading-relaxed">Muscles grow during rest. Focus on hitting your protein target.</p>
                        <button onClick={() => setAppData(p => ({...p, dailyLog: {...p.dailyLog, isRestDay: false}}))} className="w-full bg-white/10 text-white font-bold py-4 rounded-xl border border-white/20">Cancel Rest Mode</button>
                    </div>
                ) : (
                    <div>
                        <h2 className="text-3xl font-bold text-white mb-2">{(appData.totalWorkouts + 1) % 12 === 0 ? 'Deload Session' : 'Build Density'}</h2>
                        <p className="text-blue-100 text-xs mb-6 max-w-[90%] opacity-90 leading-relaxed">
                            {(appData.totalWorkouts + 1) % 12 === 0 ? 'Volume is reduced by 40% today to allow your CNS to recover.' : 'Smart Coach Active: Targets updated based on your last session\'s RPE.'}
                        </p>
                        <div className="flex gap-3">
                            <button onClick={prepareWorkout} className="flex-1 bg-white text-blue-900 font-bold py-4 rounded-xl flex items-center justify-center gap-2 hover:bg-blue-50 transition-colors shadow-lg"><Play className="w-5 h-5 fill-current" /> START</button>
                            <button onClick={() => setAppData(p => ({...p, dailyLog: {...p.dailyLog, isRestDay: true}, habitStreak: p.habitStreak + 1}))} className="px-4 bg-blue-900/50 text-blue-200 font-bold rounded-xl border border-blue-500/30 flex flex-col items-center justify-center text-[10px] gap-1"><Sofa className="w-5 h-5" /> REST</button>
                        </div>
                    </div>
                )}
            </div>
        </div>
        
        <div className="bg-neutral-900 p-5 rounded-2xl border border-neutral-800 relative">
            <div className="flex items-center gap-2 mb-3"><Brain className="w-5 h-5 text-purple-500" /><span className="text-sm font-bold text-white">Coach's Insight</span></div>
            <p className="text-xs text-neutral-400 leading-relaxed">
                {(appData.totalWorkouts < 5) ? "Focus on feeling the muscle stretch. Slow down the negative (downward) phase." : 
                 (appData.habitStreak > 5) ? "Consistency is king. Now try to increase intensity (RPE) slightly." :
                 "The mirror lies, measurements don't. Trust the waist measurement."}
            </p>
        </div>
    </div>
  );

  const FuelTab = () => {
      const { calorieTarget, proteinTarget } = calculateTargets();
      return (
        <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
            {/* MEAL ARCHITECT */}
            {showMealGuide ? (
                <div className="bg-green-900/10 border border-green-800 p-5 rounded-3xl">
                    <div className="flex justify-between items-center mb-4">
                        <div className="flex items-center gap-2"><ChefHat className="w-5 h-5 text-green-500"/><span className="text-sm font-bold text-white">Meal Architect</span></div>
                        <button onClick={() => setShowMealGuide(false)}><X className="w-4 h-4 text-neutral-500"/></button>
                    </div>
                    <div className="space-y-4 text-xs text-neutral-300">
                        <div className="bg-neutral-900/50 p-3 rounded-xl"><strong className="text-green-400 block mb-1">Breakfast ({Math.round(calorieTarget*0.25)} kcal)</strong>3 Eggs, 1 Slice Toast, Spinach. (20g Protein)</div>
                        <div className="bg-neutral-900/50 p-3 rounded-xl"><strong className="text-green-400 block mb-1">Lunch ({Math.round(calorieTarget*0.35)} kcal)</strong>Chicken Breast (150g), 1/2 Cup Rice, Veggies. (40g Protein)</div>
                        <div className="bg-neutral-900/50 p-3 rounded-xl"><strong className="text-green-400 block mb-1">Dinner ({Math.round(calorieTarget*0.30)} kcal)</strong>Lean Beef/Tofu (150g), Large Salad, 1 Potato. (40g Protein)</div>
                        <div className="bg-neutral-900/50 p-3 rounded-xl"><strong className="text-green-400 block mb-1">Snack ({Math.round(calorieTarget*0.10)} kcal)</strong>Greek Yogurt or Whey Shake. (25g Protein)</div>
                    </div>
                </div>
            ) : (
                <button onClick={() => setShowMealGuide(true)} className="w-full bg-neutral-900 border border-neutral-800 p-4 rounded-2xl flex items-center justify-between text-sm font-bold text-green-400">
                    <span className="flex items-center gap-2"><ChefHat className="w-5 h-5"/> What should I eat?</span>
                    <ChevronRight className="w-4 h-4"/>
                </button>
            )}

            {/* TRACKERS */}
            <div className="bg-neutral-900 p-6 rounded-3xl border border-neutral-800 relative overflow-hidden">
                <div className="flex justify-between items-start mb-2 relative z-10">
                    <div><div className="flex items-center gap-2 mb-1"><Utensils className="w-5 h-5 text-green-500" /><span className="text-sm font-bold text-green-500">Protein</span></div><p className="text-xs text-neutral-500">Target: {proteinTarget}g</p></div>
                    <div className="text-3xl font-black font-mono text-white">{appData.dailyLog.protein}<span className="text-sm text-neutral-600">g</span></div>
                </div>
                <div className="w-full bg-neutral-800 h-2 rounded-full mb-6 relative z-10"><div className="bg-green-500 h-full rounded-full transition-all duration-700" style={{width: `${Math.min((appData.dailyLog.protein / proteinTarget)*100, 100)}%`}}></div></div>
                <div className="grid grid-cols-3 gap-2 relative z-10">{[10, 25, 40].map(v => <button key={v} onClick={() => setAppData(p => ({...p, dailyLog: {...p.dailyLog, protein: p.dailyLog.protein + v}}))} className="py-3 bg-neutral-800 hover:bg-neutral-700 rounded-xl text-xs font-bold text-white">+{v}g</button>)}</div>
            </div>

            <div className="bg-neutral-900 p-6 rounded-3xl border border-neutral-800 relative overflow-hidden">
                <div className="flex justify-between items-start mb-2 relative z-10">
                    <div><div className="flex items-center gap-2 mb-1"><Flame className="w-5 h-5 text-orange-500" /><span className="text-sm font-bold text-orange-500">Energy</span></div><p className="text-xs text-neutral-500">Target: {calorieTarget} kcal</p></div>
                    <div className="text-3xl font-black font-mono text-white">{appData.dailyLog.calories}<span className="text-sm text-neutral-600">kcal</span></div>
                </div>
                <div className="w-full bg-neutral-800 h-2 rounded-full mb-6 relative z-10"><div className={`h-full rounded-full transition-all duration-700 ${appData.dailyLog.calories > calorieTarget + 200 ? 'bg-red-500' : 'bg-orange-500'}`} style={{width: `${Math.min((appData.dailyLog.calories / calorieTarget)*100, 100)}%`}}></div></div>
                <div className="grid grid-cols-4 gap-2 relative z-10">
                    {[100, 250, 500].map(v => <button key={v} onClick={() => setAppData(p => ({...p, dailyLog: {...p.dailyLog, calories: p.dailyLog.calories + v}}))} className="py-3 bg-neutral-800 hover:bg-neutral-700 rounded-xl text-xs font-bold text-white">+{v}</button>)}
                    <button onClick={() => setAppData(p => ({...p, dailyLog: {...p.dailyLog, calories: 0}}))} className="py-3 bg-neutral-800 hover:bg-red-900/30 text-red-400 rounded-xl text-xs font-bold"><RotateCcw className="w-4 h-4 mx-auto"/></button>
                </div>
            </div>

            <div className="grid grid-cols-2 gap-4">
                <button onClick={() => setAppData(p => ({...p, dailyLog: {...p.dailyLog, creatine: !p.dailyLog.creatine}}))} className={`p-5 rounded-2xl border flex flex-col justify-between h-32 transition-all ${appData.dailyLog.creatine ? 'bg-purple-900/20 border-purple-900/50' : 'bg-neutral-900 border-neutral-800'}`}>
                    <div className="flex justify-between items-start w-full"><div className="flex items-center gap-1"><Pill className={`w-5 h-5 ${appData.dailyLog.creatine ? 'text-purple-500' : 'text-neutral-500'}`} /><button onClick={(e) => {e.stopPropagation(); setInfoModal('creatine')}}><HelpCircle className="w-3 h-3 text-neutral-600"/></button></div>{appData.dailyLog.creatine && <CheckCircle2 className="w-5 h-5 text-purple-500" />}</div>
                    <div className="text-left"><div className={`font-bold text-sm ${appData.dailyLog.creatine ? 'text-purple-400' : 'text-white'}`}>Creatine</div><div className="text-xs text-neutral-500">5g Monohydrate</div></div>
                </button>
                <div className="bg-neutral-900 p-5 rounded-2xl border border-neutral-800 flex flex-col justify-between h-32 relative overflow-hidden">
                    <div className="flex justify-between items-start w-full relative z-10"><div className="flex items-center gap-1"><Droplets className="w-5 h-5 text-blue-500" /><button onClick={() => setInfoModal('water')}><HelpCircle className="w-3 h-3 text-neutral-600"/></button></div><span className="text-xl font-bold font-mono text-white">{appData.dailyLog.water}</span></div>
                    <button onClick={() => setAppData(p => ({...p, dailyLog: {...p.dailyLog, water: Math.min(p.dailyLog.water + 1, 8)}}))} className="w-full h-8 bg-blue-900/30 text-blue-400 rounded-lg text-xs font-bold relative z-10">+1 Cup</button>
                    <div className="absolute bottom-0 left-0 right-0 bg-blue-900/20 transition-all" style={{height: `${(appData.dailyLog.water/8)*100}%`}}></div>
                </div>
            </div>

            <div className="grid grid-cols-2 gap-4">
                <div className="bg-neutral-900 p-5 rounded-2xl border border-neutral-800 flex flex-col justify-between h-32">
                    <div className="flex justify-between items-start"><div className="flex items-center gap-1"><Moon className="w-5 h-5 text-indigo-400" /><button onClick={() => setInfoModal('sleep')}><HelpCircle className="w-3 h-3 text-neutral-600"/></button></div><span className="text-xl font-bold font-mono text-white">{appData.dailyLog.sleep}h</span></div>
                    <div className="flex gap-1">{[6, 7, 8].map(h => (<button key={h} onClick={() => setAppData(p => ({...p, dailyLog: {...p.dailyLog, sleep: h}}))} className={`flex-1 h-8 rounded-lg text-[10px] font-bold ${appData.dailyLog.sleep === h ? 'bg-indigo-600 text-white' : 'bg-neutral-800 text-neutral-400'}`}>{h}{h===8?'+':''}</button>))}</div>
                </div>
                <button onClick={() => setAppData(p => ({...p, dailyLog: {...p.dailyLog, steps: !p.dailyLog.steps}}))} className={`p-5 rounded-2xl border flex flex-col justify-between h-32 transition-all ${appData.dailyLog.steps ? 'bg-orange-900/20 border-orange-900/50' : 'bg-neutral-900 border-neutral-800'}`}>
                    <div className="flex justify-between items-start w-full"><div className="flex items-center gap-1"><Footprints className={`w-5 h-5 ${appData.dailyLog.steps ? 'text-orange-500' : 'text-neutral-500'}`} /><button onClick={(e) => {e.stopPropagation(); setInfoModal('steps')}}><HelpCircle className="w-3 h-3 text-neutral-600"/></button></div>{appData.dailyLog.steps && <CheckCircle2 className="w-5 h-5 text-orange-500" />}</div>
                    <div className="text-left"><div className={`font-bold text-sm ${appData.dailyLog.steps ? 'text-orange-400' : 'text-white'}`}>NEAT</div><div className="text-xs text-neutral-500">8k Steps</div></div>
                </button>
            </div>
        </div>
      );
  };

  const ProgressTab = () => {
    const latestWaist = parseFloat(appData.measurements[0]?.waist);
    const latestNeck = parseFloat(appData.measurements[0]?.neck);
    const latestHip = parseFloat(appData.measurements[0]?.hip);
    const height = parseFloat(appData.userProfile.height);
    const gender = appData.userProfile.gender;

    // METRICS
    const whtr = (latestWaist && height) ? (latestWaist / height).toFixed(2) : null;
    let whtrStatus = 'bad';
    if (whtr && whtr < 0.5) whtrStatus = 'good';
    if (whtr && whtr >= 0.5 && whtr < 0.53) whtrStatus = 'ok';
    const bf = calculateBodyFat(latestWaist, latestNeck, latestHip, height, gender);
    const graphData = appData.measurements.filter(m => m.waist !== '-' && m.weight !== '-').slice(0, 7).reverse();

    const saveMeasurement = () => {
        if (!waistInput && !weightInput) return;
        const newEntry = { date: new Date().toISOString().split('T')[0], waist: waistInput || '-', weight: weightInput || '-', neck: neckInput || '-', hip: hipInput || '-' };
        setAppData(prev => ({ ...prev, measurements: [newEntry, ...prev.measurements], userProfile: { ...prev.userProfile, weight: weightInput || prev.userProfile.weight } }));
        setWaistInput(''); setWeightInput(''); setNeckInput(''); setHipInput('');
    };

    return (
        <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
            {whtr && (<div className={`p-5 rounded-2xl border flex items-center justify-between ${whtrStatus === 'good' ? 'bg-green-900/20 border-green-800' : 'bg-neutral-900 border-neutral-800'}`}><div><div className="flex items-center gap-2 mb-1"><Activity className={`w-5 h-5 ${whtrStatus === 'good' ? 'text-green-500' : 'text-yellow-500'}`} /><span className="font-bold text-white">Health Score (WHtR)</span></div><p className="text-xs text-neutral-400">Target: &lt; 0.50</p></div><div className="text-right"><div className={`text-3xl font-black ${whtrStatus === 'good' ? 'text-green-500' : 'text-yellow-500'}`}>{whtr}</div><div className="text-[10px] text-neutral-500 uppercase font-bold">{whtrStatus === 'good' ? 'Athletic' : 'At Risk'}</div></div></div>)}
            
            {graphData.length > 1 && (<div className="bg-neutral-900 p-5 rounded-2xl border border-neutral-800"><div className="flex items-center gap-2 mb-4"><TrendingDown className="w-4 h-4 text-purple-500" /><span className="text-sm font-bold text-white">Recomp Trends</span></div><div className="flex h-32 items-end justify-between gap-2 px-2">{graphData.map((d, i) => (<div key={i} className="flex flex-col items-center gap-1 flex-1"><div className="w-full bg-blue-500/50 rounded-t" style={{height: `${Math.min(d.weight, 100)}px`}}></div><div className="w-full bg-purple-500 rounded-t -mt-8 border-t-2 border-black" style={{height: `${Math.min(d.waist, 100)/2}px`}}></div></div>))}</div></div>)}

            <div className="bg-neutral-900 p-5 rounded-2xl border border-neutral-800">
                <div className="flex items-center justify-between mb-4"><div className="flex items-center gap-2"><Ruler className="w-5 h-5 text-purple-500" /><span className="text-sm font-bold text-white">Body Metrics</span></div><button onClick={() => setInfoModal('recomp')} className="text-xs text-blue-400 flex items-center gap-1"><Info className="w-3 h-3"/> Guide</button></div>
                <div className="grid grid-cols-2 gap-2 mb-2"><input type="number" placeholder="Waist (cm)" value={waistInput} onChange={(e) => setWaistInput(e.target.value)} className="bg-neutral-800 text-white p-3 rounded-xl text-sm focus:outline-none focus:ring-1 focus:ring-purple-500" /><input type="number" placeholder="Weight (kg)" value={weightInput} onChange={(e) => setWeightInput(e.target.value)} className="bg-neutral-800 text-white p-3 rounded-xl text-sm focus:outline-none focus:ring-1 focus:ring-purple-500" /></div>
                <div className="grid grid-cols-2 gap-2 mb-4"><input type="number" placeholder="Neck (cm)" value={neckInput} onChange={(e) => setNeckInput(e.target.value)} className="bg-neutral-800 text-white p-3 rounded-xl text-sm focus:outline-none focus:ring-1 focus:ring-purple-500" />{appData.userProfile.gender === 'female' && <input type="number" placeholder="Hip (cm)" value={hipInput} onChange={(e) => setHipInput(e.target.value)} className="bg-neutral-800 text-white p-3 rounded-xl text-sm focus:outline-none focus:ring-1 focus:ring-purple-500" />}<button onClick={saveMeasurement} className="bg-purple-600 rounded-xl font-bold text-white text-sm py-3">Log</button></div>
                <div className="max-h-32 overflow-y-auto space-y-2">{appData.measurements.map((m, i) => (<div key={i} className="flex justify-between text-xs text-neutral-400 bg-neutral-800/50 p-2 rounded-lg"><span>{m.date}</span><span className="text-white">W:{m.waist} N:{m.neck}</span></div>))}</div>
            </div>
        </div>
    );
  };

  // --- OVERLAYS ---
  if (infoModal) {
      const content = {
          calories: { title: "Why Calories?", text: "Even with high protein, you cannot lose fat if you overeat. We set a small deficit (-15%) to burn fat without starving muscle." },
          protein: { title: "Why Protein?", text: "Protein is the building block of muscle. Without it, your workout is wasted. 2.2g/kg is the gold standard for Recomp." },
          creatine: { title: "Why Creatine?", text: "It pulls water into muscle cells (good) and helps you push 1-2 extra reps. It is the most researched supplement for muscle." },
          water: { title: "Why Water?", text: "Lipolysis (fat burning) requires water molecules. Dehydration literally stops fat loss." },
          sleep: { title: "Why Sleep?", text: "Sleep reduces Cortisol. High Cortisol stores belly fat and eats muscle. 7 hours is non-negotiable." },
          steps: { title: "Why Steps?", text: "Walking burns pure fat without stressing the body. It is your secret weapon against the belly." },
          recomp: { title: "The Recomp Truth", text: "You are losing fat and building muscle simultaneously. The scale might not move. Trust the Waist measurement." }
      };
      const info = content[infoModal];
      return (
        <div className="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 flex flex-col items-center justify-center p-6">
            <div className="bg-neutral-900 border border-neutral-800 p-6 rounded-2xl max-w-sm w-full">
                <h3 className="text-lg font-bold text-white mb-4">{info.title}</h3>
                <p className="text-neutral-300 text-sm mb-6 leading-relaxed">{info.text}</p>
                <button onClick={() => setInfoModal(null)} className="w-full bg-blue-600 text-white font-bold py-3 rounded-xl">Got it</button>
            </div>
        </div>
      );
  }

  if (morningReport) return (<div className="fixed inset-0 bg-black/95 z-50 flex flex-col items-center justify-center p-6 text-center animate-in fade-in zoom-in"><ClipboardCheck className="w-16 h-16 text-blue-500 mb-6" /><h2 className="text-2xl font-black text-white mb-2">{morningReport.title}</h2><p className="text-neutral-400 mb-8 max-w-xs">{morningReport.text}</p><button onClick={() => setMorningReport(null)} className="w-full max-w-sm bg-white text-black font-bold py-4 rounded-xl">Let's Conquer Today</button></div>);
  if (showWarmup) return (<div className="fixed inset-0 bg-indigo-950 z-50 flex flex-col items-center justify-center p-6 text-center animate-in fade-in zoom-in"><Flame className="w-16 h-16 text-orange-500 mb-6 animate-pulse" /><h2 className="text-3xl font-black text-white mb-2">Warm Up First</h2><p className="text-indigo-200 mb-8 max-w-xs">Cold muscles get injured. 2 minutes now saves 2 months of rehab.</p><button onClick={startActualWorkout} className="w-full max-w-sm bg-white text-indigo-900 font-bold py-4 rounded-xl mb-4">I'm Warm - Let's Go</button><button onClick={() => setShowWarmup(false)} className="text-indigo-400 text-sm">Cancel</button></div>);
  if (showConfetti) return (<div className="fixed inset-0 z-50 pointer-events-none flex items-center justify-center"><div className="absolute inset-0 bg-black/20"></div><div className="animate-bounce"><PartyPopper className="w-32 h-32 text-yellow-500" /></div><h2 className="absolute mt-40 text-4xl font-black text-yellow-400 text-shadow-lg animate-pulse">PERFECT DAY!</h2></div>);
  
  if (showSettings) return (<div className="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 flex flex-col items-center justify-center p-6 text-center"><div className="bg-neutral-900 border border-neutral-800 p-6 rounded-3xl w-full max-w-sm"><h2 className="text-xl font-bold text-white mb-6">Profile Settings</h2><div className="space-y-4 mb-6 text-left"><div><label className="text-xs font-bold text-neutral-500 uppercase tracking-wider block mb-2">Weight (kg)</label><input type="number" value={appData.userProfile.weight} onChange={(e) => setAppData(p => ({...p, userProfile: {...p.userProfile, weight: e.target.value}}))} className="w-full bg-neutral-800 text-white p-3 rounded-xl focus:outline-none" /></div></div><button onClick={() => setShowSettings(false)} className="w-full bg-blue-600 text-white font-bold py-3 rounded-xl">Save & Close</button></div></div>);

  // --- MAIN RENDER ---
  if (view === 'onboarding') return (<div className="min-h-screen bg-neutral-950 text-white p-6 flex flex-col justify-center max-w-md mx-auto font-sans"><div className="mb-10 text-center"><Trophy className="w-10 h-10 text-blue-500 mx-auto mb-4" /><h1 className="text-4xl font-black mb-2">Forever Fit</h1><p className="text-neutral-400">The Legacy Protocol.</p></div><div className="space-y-4 mb-8"><input className="w-full bg-neutral-900 p-4 rounded-xl text-white" placeholder="Name" onChange={e => setAppData({...appData, userProfile: {...appData.userProfile, name: e.target.value}})} /><div className="flex gap-2"><input type="number" className="w-full bg-neutral-900 p-4 rounded-xl text-white" placeholder="Weight (kg)" onChange={e => setAppData({...appData, userProfile: {...appData.userProfile, weight: e.target.value}})} /><input type="number" className="w-full bg-neutral-900 p-4 rounded-xl text-white" placeholder="Height (cm)" onChange={e => setAppData({...appData, userProfile: {...appData.userProfile, height: e.target.value}})} /></div><div className="flex gap-2"><input type="number" className="w-full bg-neutral-900 p-4 rounded-xl text-white" placeholder="Age" onChange={e => setAppData({...appData, userProfile: {...appData.userProfile, age: e.target.value}})} /><select className="w-full bg-neutral-900 p-4 rounded-xl text-white" onChange={e => setAppData({...appData, userProfile: {...appData.userProfile, gender: e.target.value}})}><option value="male">Male</option><option value="female">Female</option></select></div></div><button onClick={() => { if(appData.userProfile.name) { setAppData(p => ({...p, userProfile: {...p.userProfile, onboarded: true}})); setView('main'); }}} className="w-full bg-blue-600 text-white font-bold py-4 rounded-xl">Begin</button></div>);

  if (view === 'summary') return (<div className="min-h-screen bg-neutral-950 text-white p-6 flex flex-col items-center justify-center text-center"><CheckCircle2 className="w-20 h-20 text-green-500 mb-6" /><h1 className="text-3xl font-bold mb-2">Workout Complete</h1><p className="text-neutral-400 mb-8">Evolution Engine Updated.</p><button onClick={() => setView('main')} className="w-full max-w-xs bg-white text-black font-bold py-4 rounded-xl">Continue</button></div>);

  if (view === 'workout' && activeWorkout) {
    const ex = activeWorkout.exercises[exerciseIndex];
    const isTimed = ex.type === 'time';
    const ExerciseIcon = ex.icon || Icons.Generic;
    return (
      <div className={`fixed inset-0 flex flex-col ${isResting ? 'bg-indigo-950' : 'bg-black'} transition-colors duration-500 z-40`}>
        <div className="p-4 flex justify-between items-center safe-area-top"><div className="text-xs font-bold text-neutral-400">Ex {exerciseIndex + 1}/{activeWorkout.exercises.length}</div><button onClick={() => setShowQuit(true)}><X className="w-6 h-6 text-neutral-400" /></button></div>
        <div className="flex-1 flex flex-col items-center justify-center p-6 text-center text-white overflow-y-auto">
          {isResting ? (
            <div className="w-full max-w-sm animate-in fade-in zoom-in"><div className="text-indigo-400 font-bold text-xs mb-6">Recover</div><div className="text-[100px] font-black font-mono mb-4">{timer}</div><button onClick={handleTimerComplete} className="w-full py-4 bg-indigo-600 rounded-xl font-bold">Start Now</button></div>
          ) : (
            <div className="w-full max-w-md">
              <div className="mb-4">
                <div className="flex justify-center gap-2 mb-4">{[...Array(totalSets)].map((_,s) => <div key={s} className={`h-1 w-8 rounded-full ${s < currentSet ? 'bg-blue-500' : 'bg-neutral-800'}`}></div>)}</div>
                <div className="mb-6"><ExerciseIcon /></div>
                <h2 className="text-3xl font-black mb-4 leading-tight">{ex.name}</h2>
                <p className="text-neutral-400 text-sm bg-neutral-900/50 p-3 rounded-lg border border-neutral-800">{ex.desc}</p>
              </div>
              {/* TIMER VIEW LOGIC FIX: showTimedInput check ensures we don't show timer if user clicked "Log" */}
              {isTimed && !showTimedInput ? (
                <div>
                    <div className="text-8xl font-mono font-bold mb-8">{timer}</div>
                    <div className="space-y-3">
                        <button onClick={() => setIsPaused(!isPaused)} className="w-full bg-neutral-800 py-4 rounded-xl font-bold">{isPaused ? <Play className="mx-auto"/> : <Pause className="mx-auto"/>}</button>
                        {/* THE FIX: Button to end timer early and log data */}
                        <button onClick={() => setShowTimedInput(true)} className="w-full bg-neutral-800/50 py-3 rounded-xl font-bold text-sm text-neutral-400 hover:text-white hover:bg-neutral-800">Log Set</button>
                    </div>
                </div>
              ) : (
                <div className="space-y-4">
                    <div className="bg-neutral-900 p-2 rounded-2xl border border-neutral-800 flex items-center justify-between px-4">
                        <span className="text-xs font-bold text-neutral-500">TARGET: {ex.target}</span>
                        {isTimed ? (
                             <span className="text-3xl font-bold text-white">{ex.duration}s</span>
                        ) : (
                             <input type="number" value={repInput} onChange={(e) => setRepInput(e.target.value)} placeholder="#" className="bg-transparent text-right text-3xl font-bold w-24 focus:outline-none text-white" />
                        )}
                    </div>
                    <div className="bg-neutral-900 p-3 rounded-2xl border border-neutral-800"><div className="text-[10px] font-bold text-neutral-500 uppercase mb-2">Effort Level (RPE)</div><div className="flex gap-2"><button onClick={() => setRpeInput('easy')} className={`flex-1 py-3 rounded-xl text-xs font-bold ${rpeInput === 'easy' ? 'bg-neutral-600 text-neutral-300' : 'bg-neutral-800 text-neutral-500'}`}>Easy</button><button onClick={() => setRpeInput('good')} className={`flex-1 py-3 rounded-xl text-xs font-bold ${rpeInput === 'good' ? 'bg-yellow-600 text-white' : 'bg-neutral-800 text-yellow-500'}`}>Good</button><button onClick={() => setRpeInput('hard')} className={`flex-1 py-3 rounded-xl text-xs font-bold ${rpeInput === 'hard' ? 'bg-green-600 text-white shadow-[0_0_15px_rgba(22,163,74,0.5)]' : 'bg-neutral-800 text-green-500'}`}>Hard (Goal)</button></div></div>
                    <button onClick={handleRepComplete} disabled={(!isTimed && !repInput) || !rpeInput} className={`w-full py-4 rounded-xl font-bold transition-all ${((isTimed || repInput) && rpeInput) ? 'bg-blue-600 text-white' : 'bg-neutral-800 text-neutral-600 cursor-not-allowed'}`}>Finish Set</button>
                </div>
              )}
            </div>
          )}
        </div>
        {showQuit && <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-6"><div className="bg-neutral-900 border border-neutral-800 p-6 rounded-2xl max-w-sm w-full text-center"><h3 className="text-lg font-bold mb-4 text-white">Stop Workout?</h3><div className="flex gap-3"><button onClick={() => { setView('main'); setShowQuit(false); }} className="flex-1 bg-red-900/20 text-red-500 py-3 rounded-xl font-bold">Quit</button><button onClick={() => setShowQuit(false)} className="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold">Resume</button></div></div></div>}
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-black text-white pb-24 font-sans flex flex-col">
        <div className="p-6 pt-8 flex justify-between items-center bg-neutral-900/30 border-b border-neutral-900 sticky top-0 backdrop-blur-md z-10"><div><h1 className="text-lg font-bold flex items-center gap-2">{appData.userProfile.name} {isPerfectDayLive() && <Star className="w-4 h-4 text-yellow-500 fill-yellow-500 animate-pulse" />}</h1><p className="text-xs text-neutral-500">Day {appData.habitStreak + 1}</p></div><button onClick={() => setShowSettings(true)} className="bg-neutral-800 rounded-full w-8 h-8 flex items-center justify-center"><Settings className="w-4 h-4 text-neutral-400" /></button></div>
        <div className="p-5 flex-1 overflow-y-auto">{activeTab === 'train' && <TrainTab />}{activeTab === 'fuel' && <FuelTab />}{activeTab === 'progress' && <ProgressTab />}</div>
        <div className="fixed bottom-0 left-0 right-0 bg-neutral-900 border-t border-neutral-800 p-2 safe-area-bottom z-20"><div className="flex justify-around items-center"><button onClick={() => setActiveTab('train')} className={`flex flex-col items-center p-2 rounded-xl w-20 ${activeTab === 'train' ? 'text-white' : 'text-neutral-500'}`}><LayoutDashboard className="w-6 h-6 mb-1" /><span className="text-[10px] font-bold uppercase">Train</span></button><button onClick={() => setActiveTab('fuel')} className={`flex flex-col items-center p-2 rounded-xl w-20 ${activeTab === 'fuel' ? 'text-green-400' : 'text-neutral-500'}`}><Utensils className="w-6 h-6 mb-1" /><span className="text-[10px] font-bold uppercase">Fuel</span></button><button onClick={() => setActiveTab('progress')} className={`flex flex-col items-center p-2 rounded-xl w-20 ${activeTab === 'progress' ? 'text-blue-400' : 'text-neutral-500'}`}><BarChart3 className="w-6 h-6 mb-1" /><span className="text-[10px] font-bold uppercase">Data</span></button></div></div>
        {showSettings && <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-6"><div className="bg-neutral-900 border border-neutral-800 p-6 rounded-3xl w-full max-w-sm"><h2 className="text-xl font-bold mb-4">Settings</h2><button onClick={() => setShowSettings(false)} className="w-full bg-blue-600 font-bold py-3 rounded-xl mb-4">Close</button><button onClick={() => { if(confirm('Reset?')) { localStorage.clear(); window.location.reload(); } }} className="text-red-500 text-xs w-full">Reset App</button></div></div>}
    </div>
  );
};

export default AbsRecompLegacy;


