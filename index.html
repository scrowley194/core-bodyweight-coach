<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#09090b">
    <title>Skinny Fat Solution v22</title>
    
    <!-- React & Tailwind -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        body { background-color: #000000; color: #e4e4e7; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding-bottom: env(safe-area-inset-bottom); user-select: none; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        .safe-top { padding-top: max(16px, env(safe-area-inset-top)); }
        .glass-panel { background: #18181b; border: 1px solid #27272a; border-radius: 20px; }
        .btn-active:active { transform: scale(0.98); opacity: 0.9; }
        @keyframes fadeUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .anim-entry { animation: fadeUp 0.2s cubic-bezier(0.16, 1, 0.3, 1); }
        .modal-overlay { background: rgba(0,0,0,0.85); backdrop-filter: blur(4px); }
        
        /* Inputs */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 28px; width: 28px; border-radius: 50%; background: #fff; margin-top: -12px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #3f3f46; border-radius: 2px; }
        input, select { font-size: 16px !important; background-color: #18181b; border-color: #3f3f46; color: white; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- ICONS ---
        const Icon = ({ path, className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>;
        const Icons = {
            Brain: (p) => <Icon {...p} path={<path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 4.44-4Z"/>} />,
            Check: (p) => <Icon {...p} path={<polyline points="20 6 9 17 4 12"/>} />,
            Utensils: (p) => <Icon {...p} path={<><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></>} />,
            Moon: (p) => <Icon {...p} path={<path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/>} />,
            Dumbbell: (p) => <Icon {...p} path={<><path d="m6.5 6.5 11 11"/><path d="m21 21-1-1"/><path d="m3 3 1 1"/><path d="m18 22 4-4"/><path d="m2 6 4-4"/><path d="m3 10 7-7"/><path d="m14 21 7-7"/></>} />,
            Play: (p) => <Icon {...p} path={<polygon points="5 3 19 12 5 21 5 3"/>} />,
            Pause: (p) => <Icon {...p} path={<><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></>} />,
            Square: (p) => <Icon {...p} path={<rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>} />,
            X: (p) => <Icon {...p} path={<><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>} />,
            Footprints: (p) => <Icon {...p} path={<><path d="M4 16v-2.38C4 11.5 2.97 10.5 3 8c.03-2.72 1.49-6 4.5-6C9.37 2 11 3.8 11 8c0 1.25-.51 2.4-1.5 3.38-1 1-1.5 2.12-1.5 3.62V15s1 0 1 1-1 1-1 1H4c-1 0-1-1-1-1z"/><path d="M20 20v-2.38c0-2.12 1.03-3.12 1-5.62-.03-2.72-1.49-6-4.5-6C14.63 6 13 7.8 13 12c0 1.25.51 2.4 1.5 3.38 1 1 1.5 2.12 1.5 3.62V19s-1 0-1 1 1 1 1 1h4c1 0 1-1 1-1z"/></>} />,
            Trophy: (p) => <Icon {...p} path={<><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></>} />,
            Info: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></>} />,
            Pill: (p) => <Icon {...p} path={<><path d="m10.5 20.5 10-10a4.95 4.95 0 1 0-7-7l-10 10a4.95 4.95 0 1 0 7 7Z"/><path d="m8.5 8.5 7 7"/></>} />,
            Settings: (p) => <Icon {...p} path={<path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2zM12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>} />,
            Flame: (p) => <Icon {...p} path={<path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/>} />,
            Refresh: (p) => <Icon {...p} path={<path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>} />,
            Shield: (p) => <Icon {...p} path={<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>} />,
            Minus: (p) => <Icon {...p} path={<line x1="5" y1="12" x2="19" y2="12"/>} />,
            Plus: (p) => <Icon {...p} path={<><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></>} />,
            Download: (p) => <Icon {...p} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></>} />,
            Upload: (p) => <Icon {...p} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></>} />,
            Help: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></>} />,
        };

        // --- LADDERS & LOGIC ---
        const LADDERS = {
            Squat: [
                { name: 'Split Squat (Supported)', range: [8,10], cues: ['Hold wall', 'Control down'], eq: 'bw' },
                { name: 'Split Squat (Free)', range: [8,12], cues: ['Torso forward', 'Drive front heel'], eq: 'bw' },
                { name: 'Goblet Squat', range: [10,15], cues: ['Weight at chest', 'Elbows inside knees'], eq: 'load' },
                { name: 'Weighted Split Squat', range: [8,12], cues: ['Load front leg', 'Control down'], eq: 'load' }
            ],
            Push: [
                { name: 'Incline Push-up', range: [10,15], cues: ['Hands on bench', 'Core tight'], eq: 'bw' },
                { name: 'Push-up', range: [8,12], cues: ['Elbows 45°', 'No sagging'], eq: 'bw' },
                { name: 'Push-up (Tempo)', range: [8,10], cues: ['3s down', 'Explode up'], eq: 'bw' },
                { name: 'Band/Weighted Push-up', range: [8,12], cues: ['Band behind back', 'Full ROM'], eq: 'load' }
            ],
            Hinge: [
                { name: 'Glute Bridge', range: [15,20], cues: ['Squeeze glutes top', 'Chin tucked'], eq: 'bw' },
                { name: 'Single-Leg RDL (Supported)', range: [8,12], cues: ['Hold wall', 'Hinge hip back'], eq: 'bw' },
                { name: 'Band Good Morning', range: [12,15], cues: ['Stand on band', 'Band neck', 'Hinge'], eq: 'bands' },
                { name: 'Single-Leg RDL (Weighted)', range: [8,12], cues: ['Weight in opposite hand', 'Flat back'], eq: 'load' }
            ],
            Pull: [
                { name: 'Door Row', range: [12,15], cues: ['Towel on knob', 'Body straight'], eq: 'bw' },
                { name: 'Band Row (Seated)', range: [15,20], cues: ['Band feet', 'Shoulders down'], eq: 'bands' },
                { name: 'DB Row', range: [10,15], cues: ['Hand on bench', 'Pull to pocket'], eq: 'db' },
                { name: 'Pull-up Negative', range: [3,5], cues: ['Jump up', 'Lower 5s'], eq: 'bar' }
            ],
            Overhead: [
                { name: 'Pike Hold', range: [30,45], cues: ['Hips high', 'Push floor away'], unit: 'time', eq: 'bw' },
                { name: 'Pike Push-up', range: [5,8], cues: ['Head forward', 'Elbows in'], eq: 'bw' },
                { name: 'Band Overhead Press', range: [10,15], cues: ['Stand on band', 'Ribs down'], eq: 'bands' },
                { name: 'DB Overhead Press', range: [8,12], cues: ['Press straight up', 'No arching'], eq: 'db' }
            ],
            Core: [
                { name: 'Dead Bug', range: [10,16], cues: ['Low back glued', 'Slow tempo'], eq: 'bw' },
                { name: 'Plank', range: [45,60], unit: 'time', cues: ['Squeeze glutes', 'Pull elbows down'], eq: 'bw' },
                { name: 'Leg Lower', range: [8,12], cues: ['Control lowering', 'No swinging'], eq: 'bw' }
            ]
        };

        const WARMUP = [
            { name: 'Band Pull-Aparts', range: [15,20], cues: ['Fix posture', 'Squeeze rear delts'] },
            { name: 'Floor Y-T-W', range: [10,15], cues: ['Thumbs up', 'Shoulder health'] }
        ];

        const getFinisher = (eq=[]) => {
            if (eq.includes('dumbbells')) {
                return [
                    { name: 'DB Lateral Raise', range: [12,20], cues: ['Slight lean', 'Control down'], eq: 'db', isFinisher: true },
                    { name: 'DB Curl', range: [12,20], cues: ['No swinging', 'Full squeeze'], eq: 'db', isFinisher: true },
                ];
            }
            if (eq.includes('bands')) {
                return [
                    { name: 'Band Lateral Raise', range: [15,25], cues: ['Thumbs slightly up', 'Slow negative'], eq: 'bands', isFinisher: true },
                    { name: 'Band Curl', range: [15,25], cues: ['Elbows pinned', 'Full squeeze'], eq: 'bands', isFinisher: true },
                ];
            }
            return [
                { name: 'Pike Push-up (Pump)', range: [8,15], cues: ['Short rest', 'Stop before failure'], eq: 'bw', isFinisher: true },
                { name: 'Diamond Push-up', range: [8,15], cues: ['Elbows in', 'Full lockout'], eq: 'bw', isFinisher: true },
            ];
        };

        const getTargets = (data) => {
            const w = parseFloat(data.user.weight || 70);
            const h = parseFloat(data.user.height || 175);
            const age = parseInt(data.user.age || 30);
            const isMale = data.user.gender === 'male';
            let bmr = (10 * w) + (6.25 * h) - (5 * age) + (isMale ? 5 : -161);
            
            // Manual overrides tdee calc
            let tdee = data.user.manualCalories ? parseFloat(data.user.manualCalories) : (bmr * 1.55 + (data.user.calAdjustment || 0));

            let calTarget = Math.round(tdee);
            let protTarget = data.user.manualProtein ? parseFloat(data.user.manualProtein) : (w * 1.8);
            
            // Range logic (respecting manual tdee)
            let minCals = Math.round(tdee - 200);
            let maxCals = Math.round(tdee + 200);

            if (!data.user.manualCalories) {
                if (data.user.mode === 'cut') {
                    calTarget = Math.round(tdee * 0.85); 
                    protTarget = w * 2.2; 
                    minCals = Math.round(calTarget - 200); maxCals = Math.round(calTarget + 200);
                    if (minCals < (isMale ? 1500 : 1200)) minCals = isMale ? 1500 : 1200; 
                } else if (data.user.mode === 'build') {
                    calTarget = Math.round(tdee * 1.05); 
                    protTarget = w * 2.0;
                    minCals = Math.round(calTarget - 200); maxCals = Math.round(calTarget + 300);
                }
            }

            return { calories: calTarget, calMin: minCals, calMax: maxCals, protein: Math.round(protTarget), steps: 8000 };
        };

        const getRoutine = (data, isExpress = false) => {
            const workoutsDone = data.status.workoutsCompleted || 0;
            const isRoutineA = workoutsDone % 2 === 0;
            const preferences = data.user.preferences || {};
            const eq = data.user.equipment || [];
            
            const getEx = (baseId) => { /* Helper if used */ }; // Simplified below

            let pattern = [];
            if (data.user.freq === 4) {
                 // 4x Split: Upper / Lower
                 const split = workoutsDone % 4; // 0:Upper, 1:Lower, 2:Upper, 3:Lower
                 if (split === 0 || split === 2) pattern = ['Push', 'Pull', 'Overhead', 'Core']; 
                 else pattern = ['Squat', 'Hinge', 'Squat', 'Core']; 
            } else {
                 // 3x Full Body A/B
                 pattern = isRoutineA ? ['Squat', 'Push', 'Hinge', 'Overhead', 'Core'] : ['Hinge', 'Pull', 'Squat', 'Push', 'Core'];
                 // NOTE: Simplified A/B for robustness. A: Quad/Push, B: Hinge/Pull
                 if(isRoutineA) pattern = ['Squat', 'Push', 'Hinge', 'Core'];
                 else pattern = ['Pull', 'Overhead', 'Squat', 'Core'];
            }

            // Smart Warmup
            const hasBands = eq.includes('bands');
            const warmup = hasBands 
                ? { name: 'Band Pull-Aparts', range: [15,20], cues: ['Fix posture', 'Squeeze rear delts'], isWarmup: true }
                : { name: 'Floor Y-T-W', range: [10,15], cues: ['Thumbs up', 'Shoulder health'], isWarmup: true };

            const mainMoves = pattern.map(fam => {
                const ladder = LADDERS[fam];
                const prog = data.progression[fam] || { level: 0 };
                
                // Filter ladder to user equipment
                let available = ladder.filter(e => e.eq === 'bw' || eq.includes(e.eq) || (e.eq==='load' && (eq.includes('dumbbells') || eq.includes('bands'))));
                if (available.length === 0) available = ladder.filter(e => e.eq === 'bw');
                
                // Cap level
                const safeLevel = Math.min(prog.level, available.length - 1);
                const ex = available[safeLevel];
                
                return { ...ex, family: fam, availableCount: available.length };
            });

            // Add Finisher
            const finishers = getFinisher(eq);

            return { name: isRoutineA ? "FULL BODY A" : "FULL BODY B", exercises: [warmup, ...mainMoves, ...finishers], isExpress };
        };

        // --- COMPONENTS ---

        const Toast = ({ msg, onUndo }) => (
            <div className="fixed top-6 left-1/2 -translate-x-1/2 bg-white text-black px-6 py-3 rounded-full shadow-2xl z-50 font-bold text-sm anim-entry flex items-center gap-4 border border-gray-200">
                <div className="flex items-center gap-2"><Icons.Check className="w-4 h-4 text-green-600" /> {msg}</div>
                {onUndo && <button onClick={onUndo} className="text-xs font-black uppercase tracking-wider text-gray-500 hover:text-black">Undo</button>}
            </div>
        );

        const Modal = ({ title, children, onClose }) => (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay" onClick={onClose}>
                <div className="bg-gray-900 border border-gray-800 p-6 rounded-2xl w-full max-w-sm anim-entry" onClick={e => e.stopPropagation()}>
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-xl font-bold text-white">{title}</h3>
                        <button onClick={onClose}><Icons.X className="w-6 h-6 text-gray-500"/></button>
                    </div>
                    {children}
                </div>
            </div>
        );

        const Onboarding = ({ data, setData }) => (
            <div className="min-h-screen flex flex-col justify-center p-6 text-center">
                <div className="mb-10"><Icons.Trophy className="w-16 h-16 text-yellow-500 mx-auto mb-4" /><h1 className="text-3xl font-black text-white mb-2">FINAL CUT</h1><p className="text-gray-500">Skinny Fat Solution v22</p></div>
                <div className="space-y-6 text-left">
                    <div className="grid grid-cols-2 gap-4">
                        <div><label className="text-xs text-gray-500 uppercase font-bold tracking-widest">Weight (kg)</label><input type="number" value={data.user.weight} className="w-full bg-gray-900 border border-gray-800 rounded-xl p-4 text-white mt-2 font-bold text-xl" onChange={e => setData(p => ({...p, user: {...p.user, weight: e.target.value}}))} /></div>
                        <div><label className="text-xs text-gray-500 uppercase font-bold tracking-widest">Height (cm)</label><input type="number" value={data.user.height} className="w-full bg-gray-900 border border-gray-800 rounded-xl p-4 text-white mt-2 font-bold text-xl" onChange={e => setData(p => ({...p, user: {...p.user, height: e.target.value}}))} /></div>
                    </div>
                    <div><label className="text-xs text-gray-500 uppercase font-bold tracking-widest">Age</label><input type="number" value={data.user.age} className="w-full bg-gray-900 border border-gray-800 rounded-xl p-4 text-white mt-2 font-bold text-xl" onChange={e => setData(p => ({...p, user: {...p.user, age: e.target.value}}))} /></div>
                    <div>
                        <label className="text-xs text-gray-500 uppercase font-bold tracking-widest mb-2 block">I Have Access To:</label>
                        <div className="grid grid-cols-2 gap-2">
                            {['bands', 'dumbbells', 'pull_bar'].map(eq => (
                                <button key={eq} onClick={() => { 
                                    const curr = data.user.equipment || []; 
                                    const next = curr.includes(eq) ? curr.filter(c => c !== eq) : [...curr, eq]; 
                                    setData(p => ({...p, user: {...p.user, equipment: next}})); 
                                }} className={`p-4 rounded-xl text-xs font-bold capitalize transition-all ${data.user.equipment?.includes(eq) ? 'bg-white text-black' : 'bg-gray-900 text-gray-500 border border-gray-800'}`}>
                                    {eq.replace('_', ' ')}
                                </button>
                            ))}
                        </div>
                    </div>
                    <button onClick={() => setData(p => ({...p, user: {...p.user, supplements: !p.user.supplements}}))} className={`w-full p-4 rounded-xl flex items-center justify-between border ${data.user.supplements ? 'bg-purple-900/20 border-purple-500' : 'bg-gray-900 border-gray-800'}`}><span className="text-sm font-bold text-gray-300">Enable Supplements (Creatine)</span>{data.user.supplements ? <Icons.Check className="w-5 h-5 text-purple-400"/> : <div className="w-5 h-5 rounded-full border border-gray-600"></div>}</button>
                </div>
                <button onClick={() => { if(data.user.weight) setData(p => ({...p, user: {...p.user, onboarded: true, startDate: new Date().toISOString(), equipment: data.user.equipment || []}, view: 'dashboard'})) }} className="mt-10 w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl text-lg shadow-lg btn-active">Build My Plan</button>
            </div>
        );

        const Dashboard = ({ data, setData, showToast }) => {
            const [tab, setTab] = useState('fuel'); 
            const [modal, setModal] = useState(null); 
            const [showSettings, setShowSettings] = useState(false);
            
            const daysSinceStart = Math.floor((new Date() - new Date(data.user.startDate)) / (1000 * 60 * 60 * 24));
            const isRampUp = daysSinceStart < 14;
            
            const bw = parseFloat(data.user.weight || 70);
            let protTarget = Math.round(bw * 1.8); 
            if (isRampUp) protTarget = Math.round(protTarget * 0.85); 
            const hitsTarget = Math.ceil(protTarget / 30); 
            
            const wins = [
                data.daily.proteinHits >= (hitsTarget - 1),
                data.daily.steps >= 6000,
                data.daily.sleep >= 7,
                (data.daily.train || data.daily.rest)
            ].filter(Boolean).length;
            const ringPct = (wins / (data.user.supplements ? 5 : 4)) * 100;

            useEffect(() => { if (wins === (data.user.supplements ? 5 : 4) && window.confetti) window.confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); }, [wins]);

            const logProtein = (amount) => {
                const old = data.daily.proteinHits;
                setData(p => ({...p, daily: {...p.daily, proteinHits: old + amount}}));
                showToast(amount === 0.5 ? "Half Hit Added" : "Protein Hit Added", () => setData(p => ({...p, daily: {...p.daily, proteinHits: old}})));
            };

            let actionText = "Hit your protein.";
            let ActionIcon = Icons.Utensils;
            if (!data.daily.train && !data.daily.rest) { actionText = "Complete your session."; ActionIcon = Icons.Dumbbell; }
            else if (data.daily.steps < 6000) { actionText = "Go for a 15m walk."; ActionIcon = Icons.Footprints; }
            else if (data.daily.sleep < 7 && data.daily.sleep > 0) { actionText = "Sleep priority tonight."; ActionIcon = Icons.Moon; }
            
            // Re-render Routine Name for display
            const routineName = data.status.workoutsCompleted % 2 === 0 ? "FULL BODY A" : "FULL BODY B";

            return (
                <div className="pb-24 min-h-screen relative">
                    {showSettings && <Settings data={data} setData={setData} onClose={() => setShowSettings(false)} />}
                    {modal === 'protein' && <Modal title="What counts as a Hit?" onClose={() => setModal(null)}><ul className="space-y-3 text-sm text-gray-400"><li><strong className="text-white">1 Full Hit (30g+):</strong><br/>1 scoop whey, 1 chicken breast, 3 eggs, 1 can tuna, 1 cup Skyr.</li><li><strong className="text-white">0.5 Hit (15g):</strong><br/>Protein bar, 2 eggs, 300ml protein milk.</li></ul></Modal>}
                    {modal === 'creatine' && <Modal title="Why Creatine?" onClose={() => setModal(null)}><p className="text-sm text-gray-400 mb-4">It pulls water into muscle cells, instantly improving leverage and fullness.</p><p className="text-sm text-white font-bold">Dose: 5g (1 tsp) daily.</p></Modal>}

                    <div className="p-6 pt-8 pb-4 bg-gradient-to-b from-gray-900 to-black border-b border-gray-800 sticky top-0 z-20">
                        <div className="flex justify-between items-center mb-4">
                            <div>
                                <h2 className="text-lg font-black text-white italic">{isRampUp ? "RAMP UP PHASE" : "BUILD PHASE"}</h2>
                                <p className="text-xs text-blue-400 font-medium mt-1">{isRampUp ? "Consistency > Intensity." : "Push limits."}</p>
                            </div>
                            <div className="flex items-center gap-3">
                                <div className="relative w-10 h-10 flex items-center justify-center">
                                    <svg className="w-full h-full -rotate-90" viewBox="0 0 36 36"><path className="text-gray-800" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" strokeWidth="4" /><path className="text-green-500 transition-all duration-1000" strokeDasharray={`${ringPct}, 100`} d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" strokeWidth="4" /></svg>
                                    <span className="absolute text-[10px] font-bold text-white">{wins}/{data.user.supplements ? 5 : 4}</span>
                                </div>
                                <button onClick={() => setShowSettings(true)} className="text-gray-500"><Icons.Settings className="w-6 h-6"/></button>
                            </div>
                        </div>
                        <div className="bg-gray-800/50 p-4 rounded-xl border border-gray-700/50 flex items-center gap-3">
                            <div className="p-2 bg-blue-500/20 rounded-lg text-blue-400"><ActionIcon className="w-5 h-5" /></div>
                            <div><div className="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Right Now</div><div className="text-sm font-bold text-white">{actionText}</div></div>
                        </div>
                    </div>

                    <div className="p-4 space-y-6">
                        {tab === 'fuel' && (
                            <div className="anim-entry space-y-4">
                                <div className="glass-panel p-5">
                                    <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-white flex items-center gap-2"><Icons.Utensils className="w-5 h-5" /> Protein <button onClick={()=>setModal('protein')} className="text-gray-600"><Icons.Info className="w-4 h-4" /></button></h3><span className="text-xs text-gray-500">{data.daily.proteinHits} / {hitsTarget} Hits</span></div>
                                    <div className="flex gap-1 mb-4 h-3 rounded-full overflow-hidden bg-gray-900"><div className="bg-green-500 h-full transition-all" style={{width: `${Math.min((data.daily.proteinHits/hitsTarget)*100, 100)}%`}}></div></div>
                                    <div className="grid grid-cols-2 gap-2">
                                        <button onClick={() => logProtein(1)} className="bg-gray-800 py-3 rounded-xl text-sm font-bold text-white hover:bg-gray-700">+ Full Meal</button>
                                        <button onClick={() => logProtein(0.5)} className="bg-gray-800 py-3 rounded-xl text-sm font-bold text-gray-400 hover:bg-gray-700">+ Snack</button>
                                    </div>
                                </div>
                                <div className="glass-panel p-5">
                                    <div className="flex justify-between items-center mb-2"><h3 className="font-bold text-white flex items-center gap-2"><Icons.Moon className="w-5 h-5" /> Sleep Hours</h3><span className="text-xl font-mono font-bold text-indigo-400">{data.daily.sleep || '--'}</span></div>
                                    <div className="grid grid-cols-4 gap-1 mt-2">{[5,6,7,8].map(h => (<button key={h} onClick={() => setData(p => ({...p, daily: {...p.daily, sleep: h}}))} className={`py-3 rounded-lg text-xs font-bold border ${data.daily.sleep === h ? 'bg-indigo-600 border-indigo-500 text-white' : 'border-gray-800 text-gray-500'}`}>{h}{h===8?'+':''}</button>))}</div>
                                </div>
                                <div className="glass-panel p-5">
                                    <div className="flex justify-between items-center mb-2"><h3 className="font-bold text-white flex items-center gap-2"><Icons.Footprints className="w-5 h-5" /> Steps</h3></div>
                                    <div className="grid grid-cols-3 gap-1 mt-2">{[6000, 8000, 10000].map(s => (<button key={s} onClick={() => setData(p => ({...p, daily: {...p.daily, steps: s}}))} className={`py-3 rounded-lg text-xs font-bold border ${data.daily.steps === s ? 'bg-blue-600 border-blue-500 text-white' : 'border-gray-800 text-gray-500'}`}>{s/1000}k</button>))}</div>
                                </div>
                                {data.user.supplements && <button onClick={() => { setData(p => ({...p, daily: {...p.daily, creatine: !p.daily.creatine}})); }} className={`w-full p-4 rounded-xl flex items-center justify-between border transition-all ${data.daily.creatine ? 'bg-purple-900/20 border-purple-500' : 'bg-gray-900 border-gray-800'}`}><div className="flex items-center gap-3"><div className={`p-2 rounded-lg ${data.daily.creatine ? 'bg-purple-500 text-white' : 'bg-gray-800 text-gray-600'}`}><Icons.Pill className="w-5 h-5" /></div><span className={`font-bold ${data.daily.creatine ? 'text-white' : 'text-gray-500'}`}>Creatine (5g)</span></div><button onClick={(e) => { e.stopPropagation(); setModal('creatine'); }} className="text-gray-600"><Icons.Info className="w-5 h-5" /></button></button>}
                            </div>
                        )}

                        {tab === 'train' && (
                            <div className="anim-entry">
                                {!data.daily.train && !data.daily.rest ? (
                                    <div className="glass-panel p-6 border-blue-900/30">
                                        <div className="flex justify-between items-start mb-6">
                                            <div><div className="text-[10px] font-bold text-blue-400 uppercase tracking-widest mb-1">SESSION {data.status.workoutsCompleted + 1}</div><h2 className="text-3xl font-black text-white">{routineName}</h2></div>
                                        </div>
                                        <div className="space-y-3">
                                            <button onClick={() => setData(p => ({...p, view: 'workout', activeSession: null}))} className="w-full bg-white text-black font-bold py-4 rounded-xl flex items-center justify-center gap-2 btn-active"><Icons.Play className="w-5 h-5 fill-current" /> Start Workout</button>
                                            <button onClick={() => setData(p => ({...p, daily: {...p.daily, rest: true}}))} className="w-full py-3 rounded-xl border border-gray-800 text-gray-500 text-xs font-bold">Mark as Rest Day</button>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="glass-panel p-8 text-center border-green-900/30">
                                        <div className="text-green-500 flex justify-center mb-4"><Icons.Check className="w-12 h-12" /></div>
                                        <h2 className="text-2xl font-bold text-white mb-2">{data.daily.rest ? "Resting" : "Session Complete"}</h2>
                                        <p className="text-gray-500 text-sm">Grow time.</p>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>

                    <div className="fixed bottom-0 left-0 right-0 bg-black/90 backdrop-blur-xl border-t border-gray-800 p-2 safe-bottom grid grid-cols-2 gap-1 z-40">
                        <button onClick={() => setTab('fuel')} className={`flex flex-col items-center justify-center p-3 rounded-2xl transition-all ${tab==='fuel'?'bg-gray-800 text-white':'text-gray-500'}`}><span className="mb-1"><Icons.Utensils className="w-5 h-5" /></span><span className="text-[10px] font-bold uppercase tracking-wide">Fuel</span></button>
                        <button onClick={() => setTab('train')} className={`flex flex-col items-center justify-center p-3 rounded-2xl transition-all ${tab==='train'?'bg-gray-800 text-white':'text-gray-500'}`}><span className="mb-1"><Icons.Dumbbell className="w-5 h-5" /></span><span className="text-[10px] font-bold uppercase tracking-wide">Train</span></button>
                    </div>
                </div>
            );
        };

        const Workout = ({ data, setData, showToast }) => {
            const sessionState = useMemo(() => {
                if (data.activeSession) return data.activeSession; // Recover
                const routine = getRoutine(data);
                return { exercises: routine.exercises, index: 0, setNum: 1, startTime: Date.now() };
            }, []);

            // Sync session start to parent
            useEffect(() => { if(!data.activeSession) setData(p => ({...p, activeSession: sessionState})); }, []);

            const [idx, setIdx] = useState(data.activeSession?.index || 0);
            const [setNum, setSetNum] = useState(data.activeSession?.setNum || 1);
            const [restState, setRestState] = useState(data.activeSession?.restState || null); 
            const [activeStart, setActiveStart] = useState(null); 
            const [activeElapsed, setActiveElapsed] = useState(0); 
            const [val, setVal] = useState(0); 
            const [showSafety, setShowSafety] = useState(false);
            
            const ex = sessionState.exercises[idx];
            const totalSets = ex.isWarmup ? 1 : (ex.isFinisher ? 2 : 3);

            const [timeLeft, setTimeLeft] = useState(0);
            const [activeTimeDisplay, setActiveTimeDisplay] = useState(0);

            // Persist State
            const persistState = (updates) => {
                setData(p => ({...p, activeSession: { ...p.activeSession, index: idx, setNum: setNum, restState: restState, ...updates }}));
            };

            useEffect(() => {
                if (ex.unit === 'time') { 
                    setVal(0); 
                    if(!activeStart) setActiveTimeDisplay(activeElapsed);
                } else {
                    setVal(Math.max(0, ex.range?.[0] || 8));
                }
            }, [idx]);

            useEffect(() => {
                const tick = setInterval(() => {
                    if (restState) {
                        const remaining = Math.ceil((restState.endTime - Date.now()) / 1000);
                        setTimeLeft(Math.max(0, remaining));
                        if (remaining <= 0) {
                            setRestState(null);
                            setSetNum(s => { const next = s+1; persistState({setNum: next, restState: null}); return next; });
                            try { window.navigator.vibrate([200, 100, 200]); } catch(e){}
                        }
                    }
                    if (activeStart) {
                        const current = Math.floor((Date.now() - activeStart) / 1000) + activeElapsed;
                        setActiveTimeDisplay(current);
                    }
                }, 100);
                return () => clearInterval(tick);
            }, [restState, activeStart, activeElapsed]);

            const toggleActiveTimer = () => {
                if (activeStart) { setActiveElapsed(prev => prev + Math.floor((Date.now() - activeStart) / 1000)); setActiveStart(null); } 
                else { setActiveStart(Date.now()); }
            };
            
            const stopActiveTimer = () => { setActiveStart(null); setActiveElapsed(0); setActiveTimeDisplay(0); };

            const logSet = (rating) => {
                stopActiveTimer();
                const performance = ex.unit === 'time' ? activeTimeDisplay : val;
                const targetTop = ex.range ? ex.range[1] : 99;
                const hitTop = performance >= targetTop;

                if (!ex.isWarmup && !ex.isFinisher) {
                    const fam = ex.family;
                    const prog = data.progression[fam] || { level: 0, easyStreak: 0, hardStreak: 0 };
                    let newProg = { ...prog };

                    if (rating === 'easy') {
                        if (hitTop) {
                            newProg.easyStreak += 1; newProg.hardStreak = 0;
                            if (newProg.easyStreak >= 2) {
                                if (newProg.level < ex.availableCount - 1) { newProg.level += 1; newProg.easyStreak = 0; showToast(`Promoted to Level ${newProg.level + 1}!`); }
                                else { showToast("Max Level Reached!"); }
                            } else { showToast("One more 'Easy' to level up."); }
                        } else { showToast("Do more reps before leveling up."); }
                    } else if (rating === 'hard') {
                        newProg.hardStreak += 1; newProg.easyStreak = 0;
                        if (newProg.hardStreak >= 2) { if (newProg.level > 0) { newProg.level -= 1; showToast("Volume reduced for recovery."); } newProg.hardStreak = 0; }
                    } else { newProg.easyStreak = 0; newProg.hardStreak = 0; }
                    setData(p => ({...p, progression: {...p.progression, [fam]: newProg}}));
                }

                if (setNum < totalSets) {
                    const nextRest = { endTime: Date.now() + 60000 };
                    setRestState(nextRest);
                    persistState({ restState: nextRest, setNum: setNum + 1 });
                } else {
                    if (idx < sessionState.exercises.length - 1) {
                        setIdx(i => i + 1); setSetNum(1); setRestState(null);
                        persistState({ index: idx + 1, setNum: 1, restState: null });
                    } else {
                        setData(p => ({ ...p, view: 'dashboard', activeSession: null, status: {...p.status, workoutsCompleted: p.status.workoutsCompleted + 1}, daily: {...p.daily, train: true} }));
                        showToast("Workout Complete!");
                    }
                }
            };
            
            const skipRest = () => { setRestState(null); setSetNum(s => { const next = s+1; persistState({setNum: next, restState: null}); return next; }); };
            const minReps = ex.range ? ex.range[0] : 0;
            const maxReps = ex.range ? ex.range[1] + 5 : 99;

            return (
                <div className="min-h-screen bg-black flex flex-col p-6 safe-top pb-10">
                    {showSafety && <Modal title="Safety Check" onClose={() => setShowSafety(false)}><p className="text-gray-400 text-sm mb-2"><strong>Good Pain:</strong> Muscle burning, fatigue, "pump".</p><p className="text-gray-400 text-sm"><strong>Bad Pain:</strong> Sharp, shooting, joint pinching. <strong>Stop immediately.</strong> Reduce range of motion or swap exercise.</p></Modal>}

                    <div className="flex justify-between items-center mb-8">
                        <div className="flex items-center gap-2"><span className="text-gray-500 text-xs font-bold tracking-widest">{ex.isWarmup ? "WARM UP" : (ex.isFinisher ? "FINISHER" : `EXERCISE ${idx} / ${sessionState.exercises.length - 1}`)}</span></div>
                        <button onClick={() => { if(confirm("Quit workout?")) setData(p => ({...p, view: 'dashboard', activeSession: null})); }}><Icons.X className="w-6 h-6 text-gray-500"/></button>
                    </div>

                    {restState ? (
                        <div className="flex-1 flex flex-col justify-center text-center anim-entry">
                            <div className="text-blue-500 font-bold text-sm mb-4 tracking-widest animate-pulse">RESTING</div>
                            <div className="text-9xl font-black font-mono text-white mb-8">{timeLeft}</div>
                            <button onClick={skipRest} className="bg-gray-800 text-white px-8 py-4 rounded-full text-sm font-bold">Skip Rest</button>
                        </div>
                    ) : (
                        <div className="flex-1 flex flex-col justify-between anim-entry">
                            <div>
                                <h1 className="text-3xl font-black text-white leading-tight mb-2">{ex.name}</h1>
                                <div className="text-gray-400 text-sm flex gap-3 mb-6">
                                    <span className="bg-gray-900 px-3 py-1 rounded border border-gray-800 text-blue-400 font-bold">Range: {ex.range ? `${ex.range[0]}-${ex.range[1]}` : ex.reps} {ex.unit==='time'?'s':''}</span>
                                    <span className="bg-gray-900 px-3 py-1 rounded border border-gray-800">Set {setNum}/{totalSets}</span>
                                </div>
                                <div className="space-y-3">
                                    {ex.cues.map((c, i) => <div key={i} className="flex items-center gap-3 text-gray-300"><div className="w-1.5 h-1.5 bg-blue-500 rounded-full"></div>{c}</div>)}
                                </div>
                                <button onClick={() => setShowSafety(true)} className="mt-6 text-xs text-gray-500 underline flex items-center gap-1"><Icons.Shield className="w-3 h-3"/> Is this pain normal?</button>
                            </div>

                            <div className="space-y-6">
                                <div className="bg-gray-900 p-6 rounded-3xl flex flex-col items-center">
                                    <div className="text-gray-500 text-xs font-bold uppercase tracking-widest mb-4">{ex.unit === 'time' ? 'SECONDS' : 'REPS'}</div>
                                    
                                    {ex.unit === 'time' ? (
                                        <div className="flex flex-col items-center gap-4">
                                            <div className="text-5xl font-mono font-black text-white">{activeTimeDisplay}</div>
                                            <button onClick={toggleActiveTimer} className={`px-6 py-2 rounded-full font-bold flex items-center gap-2 ${activeStart ? 'bg-yellow-900 text-yellow-300' : 'bg-green-900 text-green-300'}`}>
                                                {activeStart ? <><Icons.Pause className="w-4 h-4"/> Pause</> : <><Icons.Play className="w-4 h-4"/> Start</>}
                                            </button>
                                        </div>
                                    ) : (
                                        <div className="flex items-center gap-6">
                                            <button onClick={() => setVal(v => Math.max(minReps, v-1))} className="w-12 h-12 bg-gray-800 rounded-full flex items-center justify-center text-white"><Icons.Minus className="w-6 h-6"/></button>
                                            <div className="text-5xl font-black text-white w-20 text-center">{val}</div>
                                            <button onClick={() => setVal(v => Math.min(maxReps, v+1))} className="w-12 h-12 bg-gray-800 rounded-full flex items-center justify-center text-white"><Icons.Plus className="w-6 h-6"/></button>
                                        </div>
                                    )}
                                </div>

                                <div>
                                    <div className="text-center text-xs text-gray-500 uppercase font-bold tracking-widest mb-2">How was the set?</div>
                                    <div className="grid grid-cols-3 gap-3">
                                        <button onClick={() => logSet('easy')} className="bg-gray-900 border border-gray-800 p-4 rounded-2xl text-green-400 font-bold hover:bg-green-900/20 active:scale-95 transition-all">Easy</button>
                                        <button onClick={() => logSet('good')} className="bg-gray-900 border border-gray-800 p-4 rounded-2xl text-blue-400 font-bold hover:bg-blue-900/20 active:scale-95 transition-all">Good</button>
                                        <button onClick={() => logSet('hard')} className="bg-gray-900 border border-gray-800 p-4 rounded-2xl text-red-400 font-bold hover:bg-red-900/20 active:scale-95 transition-all">Hard</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const Settings = ({ data, setData, onClose }) => {
            const [view, setView] = useState('menu'); 
            const downloadData = () => {
                const element = document.createElement("a");
                const file = new Blob([JSON.stringify(data)], {type: 'application/json'});
                element.href = URL.createObjectURL(file);
                element.download = "skinny_fat_data.json";
                document.body.appendChild(element); element.click();
            };
            
            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const json = JSON.parse(event.target.result);
                        if (json.user && json.log && json.history) {
                            localStorage.setItem('skinny-fat-sol-v22', JSON.stringify(json));
                            window.location.reload();
                        } else { alert("Invalid file format"); }
                    } catch (err) { alert("Error reading file"); }
                };
                reader.readAsText(file);
            };

            const FAQ = () => (
                <div className="space-y-4 h-96 overflow-y-auto"><button onClick={() => setView('menu')} className="text-xs text-blue-400 mb-2 font-bold">&larr; Back to Settings</button><div className="p-4 bg-gray-800 rounded-xl"><h4 className="font-bold text-white mb-1">Should I do cardio?</h4><p className="text-xs text-gray-400">Walks only. HIIT/running spikes cortisol which eats muscle. Aim for 8k steps.</p></div><div className="p-4 bg-gray-800 rounded-xl"><h4 className="font-bold text-white mb-1">Missed a workout?</h4><p className="text-xs text-gray-400">Just continue. Do NOT double up next time. Consistency > Intensity.</p></div><div className="p-4 bg-gray-800 rounded-xl"><h4 className="font-bold text-white mb-1">Scale not moving?</h4><p className="text-xs text-gray-400">Good. If waist is shrinking but weight is stable, you are building muscle while losing fat (Recomp).</p></div><div className="p-4 bg-gray-800 rounded-xl"><h4 className="font-bold text-white mb-1">Alcohol?</h4><p className="text-xs text-gray-400">It halts fat burning for 24h. Limit to 1 day/week if you want fast results.</p></div></div>
            );
            return (
                <div className="fixed inset-0 bg-black/90 z-50 p-6 flex flex-col justify-center">
                    <div className="bg-gray-900 p-6 rounded-2xl border border-gray-800">
                        <div className="flex justify-between items-center mb-6"><h2 className="text-xl font-bold text-white">Settings</h2><button onClick={onClose}><Icons.X className="w-6 h-6 text-gray-500"/></button></div>
                        {view === 'faq' ? <FAQ /> : (
                            <div className="space-y-4">
                                <button onClick={() => setView('faq')} className="w-full bg-gray-800 p-4 rounded-xl flex items-center justify-between text-left"><span className="font-bold text-white flex gap-2"><Icons.Help className="w-5 h-5"/> Help & FAQ</span> <span>&rarr;</span></button>
                                <div><label className="block text-xs text-gray-500 mb-2 uppercase">Manual Calorie Override</label><input type="number" placeholder="Auto" value={data.user.manualCalories || ''} onChange={e => setData(p => ({...p, user: {...p.user, manualCalories: e.target.value ? parseInt(e.target.value) : null}}))} className="w-full bg-black border border-gray-700 p-3 rounded-lg text-white" /></div>
                                <div><label className="block text-xs text-gray-500 mb-2 uppercase">Manual Protein Override</label><input type="number" placeholder="Auto" value={data.user.manualProtein || ''} onChange={e => setData(p => ({...p, user: {...p.user, manualProtein: e.target.value ? parseInt(e.target.value) : null}}))} className="w-full bg-black border border-gray-700 p-3 rounded-lg text-white" /></div>
                                
                                <div className="grid grid-cols-2 gap-2 pt-2">
                                    <button onClick={downloadData} className="border border-gray-700 text-gray-400 p-4 rounded-xl flex flex-col items-center justify-center gap-2 text-xs"><Icons.Download className="w-4 h-4" /> Export Data</button>
                                    <label className="border border-gray-700 text-gray-400 p-4 rounded-xl flex flex-col items-center justify-center gap-2 text-xs cursor-pointer hover:bg-gray-800">
                                        <Icons.Upload className="w-4 h-4" /> Restore Data
                                        <input type="file" onChange={handleImport} className="hidden" accept=".json" />
                                    </label>
                                </div>
                                <div className="text-[10px] text-gray-600 text-center pt-4">Version 22.0 • Skinny Fat Solution</div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const RecompApp = () => {
            const [data, setData] = useState({ user: { weight: '', height: '', age: '', mode: 'recomp', freq: 3, onboarded: false, equipment: [], supplements: true }, status: { workoutsCompleted: 0 }, progression: {}, daily: { proteinHits: 0, steps: 0, creatine: false, sleep: 0, train: false, rest: false }, activeSession: null, view: 'onboarding' });
            const [toast, setToast] = useState(null);
            const showToast = (msg, undo) => { setToast({msg, undo}); setTimeout(() => setToast(null), 3000); };

            useEffect(() => {
                const saved = localStorage.getItem('skinny-fat-sol-v22');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        // Safe Defaults (Migration)
                        parsed.user = { weight: '', height: '', age: '', mode: 'recomp', freq: 3, onboarded: false, equipment: [], supplements: true, ...parsed.user };
                        parsed.daily = { proteinHits: 0, steps: 0, creatine: false, sleep: 0, train: false, rest: false, ...parsed.daily };
                        parsed.progression = parsed.progression || {};
                        setData(parsed);
                    } catch(e) { console.error("Save Corrupt"); }
                }
            }, []);

            useEffect(() => { if (data.user.onboarded) localStorage.setItem('skinny-fat-sol-v22', JSON.stringify(data)); }, [data]);

            // Daily Reset Logic
            useEffect(() => {
                const lastDate = localStorage.getItem('sfs-v22-date');
                const today = new Date().toLocaleDateString();
                if (lastDate !== today) {
                    setData(p => ({...p, daily: { proteinHits: 0, steps: 0, creatine: false, sleep: 0, train: false, rest: false }}));
                    localStorage.setItem('sfs-v22-date', today);
                }
            }, []);

            if (data.view === 'onboarding') return <Onboarding data={data} setData={setData} />;
            return (
                <>
                    {toast && <Toast msg={toast.msg} onUndo={toast.onUndo} />}
                    {data.view === 'dashboard' ? <Dashboard data={data} setData={setData} showToast={showToast} /> : <Workout data={data} setData={setData} showToast={showToast} />}
                </>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<RecompApp />);
    </script>
</body>
</html>


